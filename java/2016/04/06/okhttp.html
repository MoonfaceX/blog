<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>从okhttp了解http</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="You'll never walk alone.">
    <link rel="canonical" href="http://moonfacex.github.io/blog/java/2016/04/06/okhttp.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="http://moonfacex.github.io/blog/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="http://moonfacex.github.io/blog">Moonspace</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="http://moonfacex.github.io/blog/about/">About</a>
        
          <a class="page-link" href="http://moonfacex.github.io/blog/feed.xml"></a>
        
          <a class="page-link" href="http://moonfacex.github.io/blog/index.html"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>从okhttp了解http</h1>
    <p class="meta">Apr 6, 2016</p>
  </header>

  <article class="post-content">
  <p>讲道理，计算机也是学了那么多年了，对于计算机网络的认识和理解始终停留在教科书上的那些理论层面上，这一年多来开发的android项目中的http请求都是用的httpUrlConnection封装好的方法，除了post与get的写法不同，并没有接触到http更深层次的内容，因此借着学习okhttp的这个机会，来深入看看java下的HttpClient到底应该是怎么样的</p>

<h2 id="a-hrefhttpsquaregithubiookhttpokhttpa"><em><a href="http://square.github.io/okhttp/">okhttp</a></em></h2>
<p>它是square公司开源的一个面向Android/Java应用的 http client，它的优点在于：</p>

<pre><code>支持http2和spdy，允许连接同一个服务器的请求共享一个socket
当http2不可用时，会有一个conntion pool来减少请求延迟
使用gzip压缩下载内容
有缓存机制
如果服务器有多个ip地址，当第一个请求失败后，它会尝试别的ip
</code></pre>

<p>因此第一篇文章，就来分析一下okhttp作为一个网络请求框架，大致的流程和结构是怎么样的，如果我们自己要实现一个类似于这种并发请求事务的操作，它能给我们什么启示。</p>

<p>我们还是从使用场景来入手：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="kd">final</span> <span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">();</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Request</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
<span class="lineno"> 4</span>         <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">&quot;http://publicobject.com/helloworld.txt&quot;</span><span class="o">)</span>
<span class="lineno"> 5</span>         <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="n">client</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="n">Callback</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 8</span>   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">onFailure</span><span class="o">(</span><span class="n">Call</span> <span class="n">call</span><span class="o">,</span> <span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>     <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="lineno">10</span>   <span class="o">}</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">onResponse</span><span class="o">(</span><span class="n">Call</span> <span class="n">call</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">13</span>     <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">string</span><span class="o">());</span>
<span class="lineno">14</span>   <span class="o">}</span>
<span class="lineno">15</span> <span class="o">});</span></code></pre></div>

<p>首先要有一个OkHttpClient, 它相当于是一个请求集合的总管，管理着协议版本、cache、cookie、ssl、connectingPoll、proxy等一系列跟请求有关的信息，它也是采用了builder的设计模式，代表一旦build完就不能再变了
然后request也是通过一个builder模式创建的，新建一个builder只会将method字段设置为默认的”get”并创建一个没有内容的header对象，然后设置了url，这样一个request就建成了，只有一个请求方法和url。
最后client会用这个request创建一个call，然后进行enqueue操作进行异步执行请求(execute方法是同步的执行)。</p>

<p>我们来看看这个newCall是什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">* Prepares the {@code request} to be executed at some point in the future.</span>
<span class="lineno"> 3</span> <span class="cm">*/</span>
<span class="lineno"> 4</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Call</span> <span class="n">newCall</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span> 	<span class="k">return</span> <span class="k">new</span> <span class="nf">RealCall</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
<span class="lineno"> 6</span> <span class="o">}</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="kd">protected</span> <span class="nf">RealCall</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">Request</span> <span class="n">originalRequest</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span> 	<span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
<span class="lineno">10</span> 	<span class="k">this</span><span class="o">.</span><span class="na">originalRequest</span> <span class="o">=</span> <span class="n">originalRequest</span><span class="o">;</span>
<span class="lineno">11</span> <span class="o">}</span></code></pre></div>

<p>到目前为止，感觉就是把变量像踢皮球一样踢来踢去，也没干什么事，那么就来看看enqueue吧：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">enqueue</span><span class="o">(</span><span class="n">Callback</span> <span class="n">responseCallback</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span> 	<span class="n">enqueue</span><span class="o">(</span><span class="n">responseCallback</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="lineno"> 3</span> <span class="o">}</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="n">Callback</span> <span class="n">responseCallback</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forWebSocket</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span> 	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>   		<span class="k">if</span> <span class="o">(</span><span class="n">executed</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Already Executed&quot;</span><span class="o">);</span>
<span class="lineno"> 8</span>   		<span class="n">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 9</span> 	<span class="o">}</span>
<span class="lineno">10</span> 	<span class="n">client</span><span class="o">.</span><span class="na">dispatcher</span><span class="o">().</span><span class="na">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="n">AsyncCall</span><span class="o">(</span><span class="n">responseCallback</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">));</span>
<span class="lineno">11</span> <span class="o">}</span></code></pre></div>

<p>默认是不使用webSocket(用来建立http服务器和客户端之间全双工通信的一种协议，可以不采用轮询的方式就能获得推送)的，并且把callback封装到了一个AsyncCall里面，我们在这里看到了synchronized，那可想而知这里一定有一条消息队列咯，没错，我们来看看client的dispatcher的enqueue干了些什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="n">AsyncCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="k">if</span> <span class="o">(</span><span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">maxRequests</span> <span class="o">&amp;&amp;</span> <span class="n">runningCallsForHost</span><span class="o">(</span><span class="n">call</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">maxRequestsPerHost</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>       <span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
<span class="lineno"> 4</span>       <span class="n">executorService</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
<span class="lineno"> 5</span>     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="n">readyAsyncCalls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
<span class="lineno"> 7</span>     <span class="o">}</span>
<span class="lineno"> 8</span>   <span class="o">}</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>   <span class="cm">/** Ready async calls in the order they&#39;ll be run. */</span>
<span class="lineno">11</span>   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">AsyncCall</span><span class="o">&gt;</span> <span class="n">readyAsyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;();</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>   <span class="cm">/** Running asynchronous calls. Includes canceled calls that haven&#39;t finished yet. */</span>
<span class="lineno">14</span>   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">AsyncCall</span><span class="o">&gt;</span> <span class="n">runningAsyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;();</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">ExecutorService</span> <span class="nf">executorService</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">17</span>     <span class="k">if</span> <span class="o">(</span><span class="n">executorService</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">18</span>       <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="mi">60</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
<span class="lineno">19</span>           <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;(),</span> <span class="n">Util</span><span class="o">.</span><span class="na">threadFactory</span><span class="o">(</span><span class="s">&quot;OkHttp Dispatcher&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
<span class="lineno">20</span>     <span class="o">}</span>
<span class="lineno">21</span>     <span class="k">return</span> <span class="n">executorService</span><span class="o">;</span></code></pre></div>

<p>啊哈，我们看到了 一个runningQueue，放已经扔给线程池的那些calls，因为它add之后马上会调用executorService(线程池)的execute，如果它满了或者请求同一主机的call太多，就放到readyQueue里
来看一下一个call finished之后干了什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/** Used by {@code AsyncCall#run} to signal completion. */</span>
<span class="lineno"> 2</span>   <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">finished</span><span class="o">(</span><span class="n">AsyncCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="k">if</span> <span class="o">(!</span><span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">call</span><span class="o">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">(</span><span class="s">&quot;AsyncCall wasn&#39;t running!&quot;</span><span class="o">);</span>
<span class="lineno"> 4</span>     <span class="n">promoteCalls</span><span class="o">();</span>
<span class="lineno"> 5</span>   <span class="o">}</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">promoteCalls</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="k">if</span> <span class="o">(</span><span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">maxRequests</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Already running max capacity.</span>
<span class="lineno"> 9</span>     <span class="k">if</span> <span class="o">(</span><span class="n">readyAsyncCalls</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// No ready calls to promote.</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">for</span> <span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">AsyncCall</span><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">readyAsyncCalls</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="n">i</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>       <span class="n">AsyncCall</span> <span class="n">call</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>       <span class="k">if</span> <span class="o">(</span><span class="n">runningCallsForHost</span><span class="o">(</span><span class="n">call</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">maxRequestsPerHost</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>         <span class="n">i</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
<span class="lineno">16</span>         <span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
<span class="lineno">17</span>         <span class="n">executorService</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
<span class="lineno">18</span>       <span class="o">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>       <span class="k">if</span> <span class="o">(</span><span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">maxRequests</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Reached max capacity.</span>
<span class="lineno">21</span>     <span class="o">}</span>
<span class="lineno">22</span>   <span class="o">}</span></code></pre></div>

<p>它会调用promoteCalls，代码很容易理解，就是把readyQueue里面的内容加到runningQueue里面</p>

<p>那剩下的工作就是在线程池里面做了。</p>

<p>我们看到，对于一个call，也就是我们理解的一个task，光加入线程池还不够，还要维护一个队列，存放这些个task。
其实Volley也是这样干的，会维护一个set来存放正在执行或者准备执行的task，也会维护一个cache的hashmap来存放要从cache取结果的task，并且这些task同时也要放到线程池中去执行。
仔细看看，这些个队列只是用来对这些task进行cancel和统计这些操作的，volley中也是如此，因为一个task一旦放入线程池，它就由不得我们控制了，因此这个队列是必须的。(之前说错的，okhttp是支持在已经建立链接的过程中去cancel的，而volley是不允许的)
而okhttp中，cache是在call内部控制的，而加了一个readyQueue也只是为了不让线程池处理太多向同一host发出的请求，做到了一种平衡</p>

<p>AsyncCall的run会调用自己的execute，我们看看里面来做了什么，首先要明确的是，AsycCall是RealCall的一个子类，因此new一个AsyncCall出来的时候，这个对象会持有一个RealCall的引用并能访问它的所有成员</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">execute</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 2</span>       <span class="kt">boolean</span> <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno"> 3</span>       <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 4</span>         <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">getResponseWithInterceptorChain</span><span class="o">(</span><span class="n">forWebSocket</span><span class="o">);</span>
<span class="lineno"> 5</span>         <span class="k">if</span> <span class="o">(</span><span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>           <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 7</span>           <span class="n">responseCallback</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="n">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Canceled&quot;</span><span class="o">));</span>
<span class="lineno"> 8</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno"> 9</span>           <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">10</span>           <span class="n">responseCallback</span><span class="o">.</span><span class="na">onResponse</span><span class="o">(</span><span class="n">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
<span class="lineno">11</span>         <span class="o">}</span>
<span class="lineno">12</span>       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">13</span>         <span class="k">if</span> <span class="o">(</span><span class="n">signalledCallback</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>           <span class="c1">// Do not signal the callback twice!</span>
<span class="lineno">15</span>           <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">INFO</span><span class="o">,</span> <span class="s">&quot;Callback failure for &quot;</span> <span class="o">+</span> <span class="n">toLoggableString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
<span class="lineno">16</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">17</span>           <span class="n">responseCallback</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="n">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="lineno">18</span>         <span class="o">}</span>
<span class="lineno">19</span>       <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="lineno">20</span>         <span class="n">client</span><span class="o">.</span><span class="na">dispatcher</span><span class="o">().</span><span class="na">finished</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="lineno">21</span>       <span class="o">}</span>
<span class="lineno">22</span>     <span class="o">}</span>
<span class="lineno">23</span>   <span class="o">}</span></code></pre></div>

<p>逻辑还是很清晰，通过getResponseWithInterceptorChain来获得一个response，这里要注意，cancel只会在给callback投递结果的时候才起作用，意思就是不管取消没取消，这个request都会处理，这里跟volley是不一样的，volley是在执行的时候去判断，okhttp这种处理方式好处就是不会在请求处理的状态时去cancel而导致callback还是会调用这种情况而产生的内存泄漏或者是别的问题。并且，callback的调用也是在线程池里面做的，并不能直接修改ui界面，当然了，可以用handler或者eventbus来处理这些情况。</p>

<p>下面开始进入AsyncCall的具体操作了，要得到一个response，先会调用getResoponseWithInterceptorChain：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="n">Response</span> <span class="nf">getResponseWithInterceptorChain</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">forWebSocket</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">Interceptor</span><span class="o">.</span><span class="na">Chain</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationInterceptorChain</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">originalRequest</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">);</span>
<span class="lineno"> 3</span>     <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">originalRequest</span><span class="o">);</span>
<span class="lineno"> 4</span>   <span class="o">}</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>   <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Response</span> <span class="n">proceed</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 7</span>   <span class="c1">// If there&#39;s another interceptor in the chain, call that.</span>
<span class="lineno"> 8</span>   <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">client</span><span class="o">.</span><span class="na">interceptors</span><span class="o">().</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno"> 9</span>     <span class="n">Interceptor</span><span class="o">.</span><span class="na">Chain</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApplicationInterceptorChain</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">);</span>
<span class="lineno">10</span>     <span class="n">Interceptor</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">interceptors</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="lineno">11</span>     <span class="n">Response</span> <span class="n">interceptedResponse</span> <span class="o">=</span> <span class="n">interceptor</span><span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">chain</span><span class="o">);</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="k">if</span> <span class="o">(</span><span class="n">interceptedResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">(</span><span class="s">&quot;application interceptor &quot;</span> <span class="o">+</span> <span class="n">interceptor</span>
<span class="lineno">15</span>           <span class="o">+</span> <span class="s">&quot; returned null&quot;</span><span class="o">);</span>
<span class="lineno">16</span>     <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="k">return</span> <span class="n">interceptedResponse</span><span class="o">;</span>
<span class="lineno">19</span>   <span class="o">}</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>   <span class="c1">// No more interceptors. Do HTTP.</span>
<span class="lineno">22</span>   <span class="k">return</span> <span class="nf">getResponse</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">);</span>
<span class="lineno">23</span> <span class="o">}</span></code></pre></div>

<p>proceed函数中，首先判断client中还有没有拦截器了，如果有，则会用当前的拦截器index和request以及websocket标记创建一个新的chain，并调用interceptor的intercept方法把chain传进去，这样就能把request信息传递给interceptor，那interceptor可以做一些拦截的工作，并在intetercept(chain)方法中返回chain.proceed返回的response，这样在做完拦截工作，还会再一次调用chain的processd方法以进入下一个interceptor，最终index加满了最终调用getResponse，再把结果一层一层传递回去。有没有一点AOP的思想在里面呢？可以看看官方给的一个<a href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/LoggingInterceptors.java">demo</a>, 很好理解</p>

<p>最终还是会调用getResponse的，代码很长，一段段来看：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Performs the request and returns the response. May return null if this call was canceled.</span>
<span class="lineno"> 3</span> <span class="cm">   */</span>
<span class="lineno"> 4</span>   <span class="n">Response</span> <span class="nf">getResponse</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forWebSocket</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 5</span>     <span class="c1">// Copy body metadata to the appropriate request headers.</span>
<span class="lineno"> 6</span>     <span class="n">RequestBody</span> <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
<span class="lineno"> 7</span>     <span class="k">if</span> <span class="o">(</span><span class="n">body</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>       <span class="n">Request</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>       <span class="n">MediaType</span> <span class="n">contentType</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="na">contentType</span><span class="o">();</span>
<span class="lineno">11</span>       <span class="k">if</span> <span class="o">(</span><span class="n">contentType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">requestBuilder</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Content-Type&quot;</span><span class="o">,</span> <span class="n">contentType</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="lineno">13</span>       <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>       <span class="kt">long</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="na">contentLength</span><span class="o">();</span>
<span class="lineno">16</span>       <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="n">requestBuilder</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Content-Length&quot;</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">contentLength</span><span class="o">));</span>
<span class="lineno">18</span>         <span class="n">requestBuilder</span><span class="o">.</span><span class="na">removeHeader</span><span class="o">(</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="o">);</span>
<span class="lineno">19</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">20</span>         <span class="n">requestBuilder</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="o">,</span> <span class="s">&quot;chunked&quot;</span><span class="o">);</span>
<span class="lineno">21</span>         <span class="n">requestBuilder</span><span class="o">.</span><span class="na">removeHeader</span><span class="o">(</span><span class="s">&quot;Content-Length&quot;</span><span class="o">);</span>
<span class="lineno">22</span>       <span class="o">}</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>       <span class="n">request</span> <span class="o">=</span> <span class="n">requestBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">25</span>     <span class="o">}</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>     <span class="c1">// Create the initial HTTP engine. Retries and redirects need new engine for each attempt.</span>
<span class="lineno">28</span>     <span class="n">engine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpEngine</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span></code></pre></div>

<p>出现了我们熟悉的格式，如果有body的话，会在头部加上Content-Type、Transfer-Encoding这些请求头，当然也是用了builder的设计模式
最后一行创建了一个HttpEngine，看看是什么鬼：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="nf">HttpEngine</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">bufferRequestBody</span><span class="o">,</span>
<span class="lineno"> 2</span>       <span class="kt">boolean</span> <span class="n">callerWritesRequestBody</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forWebSocket</span><span class="o">,</span> <span class="n">StreamAllocation</span> <span class="n">streamAllocation</span><span class="o">,</span>
<span class="lineno"> 3</span>       <span class="n">RetryableSink</span> <span class="n">requestBodyOut</span><span class="o">,</span> <span class="n">Response</span> <span class="n">priorResponse</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 4</span>     <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
<span class="lineno"> 5</span>     <span class="k">this</span><span class="o">.</span><span class="na">userRequest</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
<span class="lineno"> 6</span>     <span class="k">this</span><span class="o">.</span><span class="na">bufferRequestBody</span> <span class="o">=</span> <span class="n">bufferRequestBody</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="k">this</span><span class="o">.</span><span class="na">callerWritesRequestBody</span> <span class="o">=</span> <span class="n">callerWritesRequestBody</span><span class="o">;</span>
<span class="lineno"> 8</span>     <span class="k">this</span><span class="o">.</span><span class="na">forWebSocket</span> <span class="o">=</span> <span class="n">forWebSocket</span><span class="o">;</span>
<span class="lineno"> 9</span>     <span class="k">this</span><span class="o">.</span><span class="na">streamAllocation</span> <span class="o">=</span> <span class="n">streamAllocation</span> <span class="o">!=</span> <span class="kc">null</span>
<span class="lineno">10</span>         <span class="o">?</span> <span class="n">streamAllocation</span>
<span class="lineno">11</span>         <span class="o">:</span> <span class="k">new</span> <span class="n">StreamAllocation</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">connectionPool</span><span class="o">(),</span> <span class="n">createAddress</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">request</span><span class="o">));</span>
<span class="lineno">12</span>     <span class="k">this</span><span class="o">.</span><span class="na">requestBodyOut</span> <span class="o">=</span> <span class="n">requestBodyOut</span><span class="o">;</span>
<span class="lineno">13</span>     <span class="k">this</span><span class="o">.</span><span class="na">priorResponse</span> <span class="o">=</span> <span class="n">priorResponse</span><span class="o">;</span>
<span class="lineno">14</span>   <span class="o">}</span></code></pre></div>

<p>其他的参数都是一堆null和false，我们暂时不关心，不过StreamAllocation看起来蛮高大上的因为必须要new出一个，我们先来看看它们的参数，ConnectionPool：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm"> * Manages reuse of HTTP and SPDY connections for reduced network latency. HTTP requests that share</span>
<span class="lineno"> 3</span> <span class="cm"> * the same {@link Address} may share a {@link Connection}. This class implements the policy of</span>
<span class="lineno"> 4</span> <span class="cm"> * which connections to keep open for future use.</span>
<span class="lineno"> 5</span> <span class="cm"> */</span>
<span class="lineno"> 6</span> <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ConnectionPool</span> <span class="o">{</span>
<span class="lineno"> 7</span>   <span class="cm">/**</span>
<span class="lineno"> 8</span> <span class="cm">   * Create a new connection pool with tuning parameters appropriate for a single-user application.</span>
<span class="lineno"> 9</span> <span class="cm">   * The tuning parameters in this pool are subject to change in future OkHttp releases. Currently</span>
<span class="lineno">10</span> <span class="cm">   * this pool holds up to 5 idle connections which will be evicted after 5 minutes of inactivity.</span>
<span class="lineno">11</span> <span class="cm">   */</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">RealConnection</span><span class="o">&gt;</span> <span class="n">connections</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;();</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>   <span class="kd">public</span> <span class="nf">ConnectionPool</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">16</span>     <span class="k">this</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
<span class="lineno">17</span>   <span class="o">}</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>   <span class="kd">public</span> <span class="nf">ConnectionPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxIdleConnections</span><span class="o">,</span> <span class="kt">long</span> <span class="n">keepAliveDuration</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">20</span>     <span class="k">this</span><span class="o">.</span><span class="na">maxIdleConnections</span> <span class="o">=</span> <span class="n">maxIdleConnections</span><span class="o">;</span>
<span class="lineno">21</span>     <span class="k">this</span><span class="o">.</span><span class="na">keepAliveDurationNs</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveDuration</span><span class="o">);</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>     <span class="c1">// Put a floor on the keep alive duration, otherwise cleanup will spin loop.</span>
<span class="lineno">24</span>     <span class="k">if</span> <span class="o">(</span><span class="n">keepAliveDuration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">25</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;keepAliveDuration &lt;= 0: &quot;</span> <span class="o">+</span> <span class="n">keepAliveDuration</span><span class="o">);</span>
<span class="lineno">26</span>     <span class="o">}</span>
<span class="lineno">27</span>   <span class="o">}</span>
<span class="lineno">28</span>  <span class="o">}</span></code></pre></div>

<p>大致意思就是用一个connection双端队列来保存一些连接，因为后续有可能有别的请求是针对同一地址的，那现在不立即关闭这些连接以备后续使用，可以减少延迟</p>

<p>在看看createAddress：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="kd">static</span> <span class="n">Address</span> <span class="nf">createAddress</span><span class="o">(</span><span class="n">OkHttpClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno"> 3</span>     <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno"> 4</span>     <span class="n">CertificatePinner</span> <span class="n">certificatePinner</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno"> 5</span>     <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isHttps</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">sslSocketFactory</span><span class="o">();</span>
<span class="lineno"> 7</span>       <span class="n">hostnameVerifier</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">hostnameVerifier</span><span class="o">();</span>
<span class="lineno"> 8</span>       <span class="n">certificatePinner</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">certificatePinner</span><span class="o">();</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">return</span> <span class="k">new</span> <span class="nf">Address</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">host</span><span class="o">(),</span> <span class="n">request</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">port</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">dns</span><span class="o">(),</span>
<span class="lineno">12</span>         <span class="n">client</span><span class="o">.</span><span class="na">socketFactory</span><span class="o">(),</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">,</span> <span class="n">certificatePinner</span><span class="o">,</span>
<span class="lineno">13</span>         <span class="n">client</span><span class="o">.</span><span class="na">proxyAuthenticator</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">proxy</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">protocols</span><span class="o">(),</span>
<span class="lineno">14</span>         <span class="n">client</span><span class="o">.</span><span class="na">connectionSpecs</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">proxySelector</span><span class="o">());</span>
<span class="lineno">15</span>   <span class="o">}</span></code></pre></div>

<p>这里会根据request和client的配置信息，比如是否要用https呀proxy的选择以及支持的协议等等，最后生成的Address对象会表示这个请求的地址信息</p>

<p>然后是StreamAlloction， 它维护了三个东西：</p>

<pre><code>1.	Connections：对远程服务器的物理socket连接，当然了，它的建立是
	一个相对缓慢的过程，因此我们要尽可能的复用他
2.	Streams：基于connections的逻辑层面上的request/response，
	这就是在socket连接上可以复用不同的请求，HTTP/1.X只能支持一个stream，
	而SPDY和HTTP/2.0就支持多个stream共用一个connection了
3.	Calls：就是一个个的request，一个call可能有好几个连续的request
	(比如返回一个html页面但是要继续发请求获取图片信息)，这时候就可以在一个connection中使用
	多个stream来做这些事情而不用重新建立connection
</code></pre>

<p>不过它的构造函数里除了设置一个RouteSelector什么也没做：</p>

<div class="highlight"><pre><code class="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="nf">StreamAllocation</span><span class="o">(</span><span class="n">ConnectionPool</span> <span class="n">connectionPool</span><span class="o">,</span> <span class="n">Address</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">2</span>     <span class="k">this</span><span class="o">.</span><span class="na">connectionPool</span> <span class="o">=</span> <span class="n">connectionPool</span><span class="o">;</span>
<span class="lineno">3</span>     <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span>
<span class="lineno">4</span>     <span class="k">this</span><span class="o">.</span><span class="na">routeSelector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RouteSelector</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">routeDatabase</span><span class="o">());</span>
<span class="lineno">5</span>   <span class="o">}</span></code></pre></div>

<p>其中RouteSelector会给我们一个连接失败后重新选择备用address和proxy的机会，确实想的很周到</p>

<p>回到getResponse， 来看剩下的部分：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kt">int</span> <span class="n">followUpCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno"> 2</span>     <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>       <span class="k">if</span> <span class="o">(</span><span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 4</span>         <span class="n">engine</span><span class="o">.</span><span class="na">releaseStreamAllocation</span><span class="o">();</span>
<span class="lineno"> 5</span>         <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Canceled&quot;</span><span class="o">);</span>
<span class="lineno"> 6</span>       <span class="o">}</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>       <span class="kt">boolean</span> <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 9</span>       <span class="k">try</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="n">engine</span><span class="o">.</span><span class="na">sendRequest</span><span class="o">();</span>
<span class="lineno">11</span>         <span class="n">engine</span><span class="o">.</span><span class="na">readResponse</span><span class="o">();</span>
<span class="lineno">12</span>         <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">13</span>       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RequestException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>         <span class="c1">// The attempt to interpret the request failed. Give up.</span>
<span class="lineno">15</span>         <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
<span class="lineno">16</span>       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RouteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="c1">// The attempt to connect via a route failed. The request will not have been sent.</span>
<span class="lineno">18</span>         <span class="n">HttpEngine</span> <span class="n">retryEngine</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">recover</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getLastConnectException</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
<span class="lineno">19</span>         <span class="k">if</span> <span class="o">(</span><span class="n">retryEngine</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">20</span>           <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">21</span>           <span class="n">engine</span> <span class="o">=</span> <span class="n">retryEngine</span><span class="o">;</span>
<span class="lineno">22</span>           <span class="k">continue</span><span class="o">;</span>
<span class="lineno">23</span>         <span class="o">}</span>
<span class="lineno">24</span>         <span class="c1">// Give up; recovery is not possible.</span>
<span class="lineno">25</span>         <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getLastConnectException</span><span class="o">();</span>
<span class="lineno">26</span>       <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">27</span>         <span class="c1">// An attempt to communicate with a server failed. The request may have been sent.</span>
<span class="lineno">28</span>         <span class="n">HttpEngine</span> <span class="n">retryEngine</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">recover</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="lineno">29</span>         <span class="k">if</span> <span class="o">(</span><span class="n">retryEngine</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">30</span>           <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">31</span>           <span class="n">engine</span> <span class="o">=</span> <span class="n">retryEngine</span><span class="o">;</span>
<span class="lineno">32</span>           <span class="k">continue</span><span class="o">;</span>
<span class="lineno">33</span>         <span class="o">}</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>         <span class="c1">// Give up; recovery is not possible.</span>
<span class="lineno">36</span>         <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
<span class="lineno">37</span>       <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="lineno">38</span>         <span class="c1">// We&#39;re throwing an unchecked exception. Release any resources.</span>
<span class="lineno">39</span>         <span class="k">if</span> <span class="o">(</span><span class="n">releaseConnection</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">40</span>           <span class="n">StreamAllocation</span> <span class="n">streamAllocation</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="lineno">41</span>           <span class="n">streamAllocation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="lineno">42</span>         <span class="o">}</span>
<span class="lineno">43</span>       <span class="o">}</span>
<span class="lineno">44</span> 
<span class="lineno">45</span>       <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
<span class="lineno">46</span>       <span class="n">Request</span> <span class="n">followUp</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">followUpRequest</span><span class="o">();</span>
<span class="lineno">47</span> 
<span class="lineno">48</span>       <span class="k">if</span> <span class="o">(</span><span class="n">followUp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">49</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">forWebSocket</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">50</span>           <span class="n">engine</span><span class="o">.</span><span class="na">releaseStreamAllocation</span><span class="o">();</span>
<span class="lineno">51</span>         <span class="o">}</span>
<span class="lineno">52</span>         <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="lineno">53</span>       <span class="o">}</span>
<span class="lineno">54</span> 
<span class="lineno">55</span>       <span class="n">StreamAllocation</span> <span class="n">streamAllocation</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="lineno">56</span> 
<span class="lineno">57</span>       <span class="k">if</span> <span class="o">(++</span><span class="n">followUpCount</span> <span class="o">&gt;</span> <span class="n">MAX_FOLLOW_UPS</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">58</span>         <span class="n">streamAllocation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="lineno">59</span>         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ProtocolException</span><span class="o">(</span><span class="s">&quot;Too many follow-up requests: &quot;</span> <span class="o">+</span> <span class="n">followUpCount</span><span class="o">);</span>
<span class="lineno">60</span>       <span class="o">}</span>
<span class="lineno">61</span> 
<span class="lineno">62</span>       <span class="k">if</span> <span class="o">(!</span><span class="n">engine</span><span class="o">.</span><span class="na">sameConnection</span><span class="o">(</span><span class="n">followUp</span><span class="o">.</span><span class="na">url</span><span class="o">()))</span> <span class="o">{</span>
<span class="lineno">63</span>         <span class="n">streamAllocation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="lineno">64</span>         <span class="n">streamAllocation</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">65</span>       <span class="o">}</span>
<span class="lineno">66</span> 
<span class="lineno">67</span>       <span class="n">request</span> <span class="o">=</span> <span class="n">followUp</span><span class="o">;</span>
<span class="lineno">68</span>       <span class="n">engine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpEngine</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">,</span> <span class="n">streamAllocation</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
<span class="lineno">69</span>           <span class="n">response</span><span class="o">);</span>
<span class="lineno">70</span>     <span class="o">}</span></code></pre></div>

<p>代码比较长，一点一点来看：</p>

<ul>
  <li>
    <p>先是一个while循环，代表处理这个connection一系列的streams</p>
  </li>
  <li>
    <p>如果这个call被标记为cancel，那就释放这个StreamAllocation，本质上是释放connection，但也有可能把它放入connectionsPool来供以后使用</p>
  </li>
  <li>
    <p>第10、11行尝试通过engine做具体的发送请求和读取响应的操作，但这其中可能会抛出一些异常</p>
  </li>
  <li>
    <p>如果网络不好，可能会抛出RequestExecpton</p>
  </li>
  <li>
    <p>如果路由失败或者是链接服务器失败，会将engine替换为Router中下个可选的retryEngine</p>
  </li>
  <li>
    <p>如果有其他异常，将这个engine关闭，并释放它的StreamAllocation，跟第二条的释放操作一样一样的</p>
  </li>
  <li>
    <p>拿到response，并判断有没有要继续发送的request，如果没有，并且不启用webSocket(默认不启用)，那么同上，释放SteamAllocation并返回response</p>
  </li>
  <li>
    <p>如果还有followUp的request，先会把engine关闭，但不会释放他的streamAlloction，如果当前的connection的url跟followUp的url不同，那么就会释放原本的StreamAllocation，否则就会保持，最后再新建一个engine对下一次的request进行操作</p>
  </li>
</ul>

<p>看上去好像engine承担了很多的重任啊，刚才就new了一个，啥也没讲，现在来说一下它大概的作用：</p>

<pre><code>一个HttpEngine处理一对request/response事件，也就一个单位的http请求，它先会通过sendRequeset发送
请求，然后通过readResponse获得响应。这就是为什么while循环中每次都要创建一个新的engine的原因，它的
作用域仅仅是一次http请求
</code></pre>

<p>那我们就来看看sendRequeset：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendRequest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RequestException</span><span class="o">,</span> <span class="n">RouteException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="k">if</span> <span class="o">(</span><span class="n">cacheStrategy</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// Already sent.</span>
<span class="lineno"> 3</span>     <span class="k">if</span> <span class="o">(</span><span class="n">httpStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">();</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="n">networkRequest</span><span class="o">(</span><span class="n">userRequest</span><span class="o">);</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="n">InternalCache</span> <span class="n">responseCache</span> <span class="o">=</span> <span class="n">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">internalCache</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
<span class="lineno"> 8</span>     <span class="n">Response</span> <span class="n">cacheCandidate</span> <span class="o">=</span> <span class="n">responseCache</span> <span class="o">!=</span> <span class="kc">null</span>
<span class="lineno"> 9</span>         <span class="o">?</span> <span class="n">responseCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
<span class="lineno">10</span>         <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="lineno">13</span>     <span class="n">cacheStrategy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="na">Factory</span><span class="o">(</span><span class="n">now</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">cacheCandidate</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
<span class="lineno">14</span>     <span class="n">networkRequest</span> <span class="o">=</span> <span class="n">cacheStrategy</span><span class="o">.</span><span class="na">networkRequest</span><span class="o">;</span>
<span class="lineno">15</span>     <span class="n">cacheResponse</span> <span class="o">=</span> <span class="n">cacheStrategy</span><span class="o">.</span><span class="na">cacheResponse</span><span class="o">;</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="k">if</span> <span class="o">(</span><span class="n">responseCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">18</span>       <span class="n">responseCache</span><span class="o">.</span><span class="na">trackResponse</span><span class="o">(</span><span class="n">cacheStrategy</span><span class="o">);</span>
<span class="lineno">19</span>     <span class="o">}</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>     <span class="k">if</span> <span class="o">(</span><span class="n">cacheCandidate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cacheResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">22</span>       <span class="n">closeQuietly</span><span class="o">(</span><span class="n">cacheCandidate</span><span class="o">.</span><span class="na">body</span><span class="o">());</span> <span class="c1">// The cache candidate wasn&#39;t applicable. Close it.</span>
<span class="lineno">23</span>     <span class="o">}</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="c1">// If we&#39;re forbidden from using the network and the cache is insufficient, fail.</span>
<span class="lineno">26</span>     <span class="k">if</span> <span class="o">(</span><span class="n">networkRequest</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cacheResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">27</span>       <span class="n">userResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Response</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
<span class="lineno">28</span>           <span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">userRequest</span><span class="o">)</span>
<span class="lineno">29</span>           <span class="o">.</span><span class="na">priorResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">priorResponse</span><span class="o">))</span>
<span class="lineno">30</span>           <span class="o">.</span><span class="na">protocol</span><span class="o">(</span><span class="n">Protocol</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">)</span>
<span class="lineno">31</span>           <span class="o">.</span><span class="na">code</span><span class="o">(</span><span class="mi">504</span><span class="o">)</span>
<span class="lineno">32</span>           <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="s">&quot;Unsatisfiable Request (only-if-cached)&quot;</span><span class="o">)</span>
<span class="lineno">33</span>           <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">EMPTY_BODY</span><span class="o">)</span>
<span class="lineno">34</span>           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">35</span>       <span class="k">return</span><span class="o">;</span>
<span class="lineno">36</span>     <span class="o">}</span>
<span class="lineno">37</span> 
<span class="lineno">38</span>     <span class="c1">// If we don&#39;t need the network, we&#39;re done.</span>
<span class="lineno">39</span>     <span class="k">if</span> <span class="o">(</span><span class="n">networkRequest</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">40</span>       <span class="n">userResponse</span> <span class="o">=</span> <span class="n">cacheResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
<span class="lineno">41</span>           <span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">userRequest</span><span class="o">)</span>
<span class="lineno">42</span>           <span class="o">.</span><span class="na">priorResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">priorResponse</span><span class="o">))</span>
<span class="lineno">43</span>           <span class="o">.</span><span class="na">cacheResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">))</span>
<span class="lineno">44</span>           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">45</span>       <span class="n">userResponse</span> <span class="o">=</span> <span class="n">unzip</span><span class="o">(</span><span class="n">userResponse</span><span class="o">);</span>
<span class="lineno">46</span>       <span class="k">return</span><span class="o">;</span>
<span class="lineno">47</span>     <span class="o">}</span>
<span class="lineno">48</span> 
<span class="lineno">49</span>     <span class="c1">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span>
<span class="lineno">50</span>     <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">51</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno">52</span>       <span class="n">httpStream</span> <span class="o">=</span> <span class="n">connect</span><span class="o">();</span>
<span class="lineno">53</span>       <span class="n">httpStream</span><span class="o">.</span><span class="na">setHttpEngine</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="lineno">54</span> 
<span class="lineno">55</span>       <span class="k">if</span> <span class="o">(</span><span class="n">writeRequestHeadersEagerly</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">56</span>         <span class="kt">long</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">OkHeaders</span><span class="o">.</span><span class="na">contentLength</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="lineno">57</span>         <span class="k">if</span> <span class="o">(</span><span class="n">bufferRequestBody</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">58</span>           <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">&gt;</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">59</span>             <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Use setFixedLengthStreamingMode() or &quot;</span>
<span class="lineno">60</span>                 <span class="o">+</span> <span class="s">&quot;setChunkedStreamingMode() for requests larger than 2 GiB.&quot;</span><span class="o">);</span>
<span class="lineno">61</span>           <span class="o">}</span>
<span class="lineno">62</span> 
<span class="lineno">63</span>           <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">64</span>             <span class="c1">// Buffer a request body of a known length.</span>
<span class="lineno">65</span>             <span class="n">httpStream</span><span class="o">.</span><span class="na">writeRequestHeaders</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">);</span>
<span class="lineno">66</span>             <span class="n">requestBodyOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RetryableSink</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">contentLength</span><span class="o">);</span>
<span class="lineno">67</span>           <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">68</span>             <span class="c1">// Buffer a request body of an unknown length. Don&#39;t write request headers until the</span>
<span class="lineno">69</span>             <span class="c1">// entire body is ready; otherwise we can&#39;t set the Content-Length header correctly.</span>
<span class="lineno">70</span>             <span class="n">requestBodyOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RetryableSink</span><span class="o">();</span>
<span class="lineno">71</span>           <span class="o">}</span>
<span class="lineno">72</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">73</span>           <span class="n">httpStream</span><span class="o">.</span><span class="na">writeRequestHeaders</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">);</span>
<span class="lineno">74</span>           <span class="n">requestBodyOut</span> <span class="o">=</span> <span class="n">httpStream</span><span class="o">.</span><span class="na">createRequestBody</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">,</span> <span class="n">contentLength</span><span class="o">);</span>
<span class="lineno">75</span>         <span class="o">}</span>
<span class="lineno">76</span>       <span class="o">}</span>
<span class="lineno">77</span>       <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">78</span>     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="lineno">79</span>       <span class="c1">// If we&#39;re crashing on I/O or otherwise, don&#39;t leak the cache body.</span>
<span class="lineno">80</span>       <span class="k">if</span> <span class="o">(!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">cacheCandidate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">81</span>         <span class="n">closeQuietly</span><span class="o">(</span><span class="n">cacheCandidate</span><span class="o">.</span><span class="na">body</span><span class="o">());</span>
<span class="lineno">82</span>       <span class="o">}</span>
<span class="lineno">83</span>     <span class="o">}</span>
<span class="lineno">84</span>   <span class="o">}</span></code></pre></div>

<p>又是一大坨，我们慢慢来看，先是networkRequest()：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Populates request with defaults and cookies.</span>
<span class="lineno"> 3</span> <span class="cm">   *</span>
<span class="lineno"> 4</span> <span class="cm">   * &lt;p&gt;This client doesn&#39;t specify a default {@code Accept} header because it doesn&#39;t know what</span>
<span class="lineno"> 5</span> <span class="cm">   * content types the application is interested in.</span>
<span class="lineno"> 6</span> <span class="cm">   */</span>
<span class="lineno"> 7</span>   <span class="kd">private</span> <span class="n">Request</span> <span class="nf">networkRequest</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="n">Request</span><span class="o">.</span><span class="na">Builder</span> <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>     <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Host&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">11</span>       <span class="n">result</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Host&quot;</span><span class="o">,</span> <span class="n">hostHeader</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">url</span><span class="o">(),</span> <span class="kc">false</span><span class="o">));</span>
<span class="lineno">12</span>     <span class="o">}</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>     <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Connection&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>       <span class="n">result</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Connection&quot;</span><span class="o">,</span> <span class="s">&quot;Keep-Alive&quot;</span><span class="o">);</span>
<span class="lineno">16</span>     <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Accept-Encoding&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>       <span class="n">transparentGzip</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">20</span>       <span class="n">result</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Accept-Encoding&quot;</span><span class="o">,</span> <span class="s">&quot;gzip&quot;</span><span class="o">);</span>
<span class="lineno">21</span>     <span class="o">}</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>     <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">cookieJar</span><span class="o">().</span><span class="na">loadForRequest</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">url</span><span class="o">());</span>
<span class="lineno">24</span>     <span class="k">if</span> <span class="o">(!</span><span class="n">cookies</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">25</span>       <span class="n">result</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Cookie&quot;</span><span class="o">,</span> <span class="n">cookieHeader</span><span class="o">(</span><span class="n">cookies</span><span class="o">));</span>
<span class="lineno">26</span>     <span class="o">}</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">29</span>       <span class="n">result</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span><span class="o">,</span> <span class="n">Version</span><span class="o">.</span><span class="na">userAgent</span><span class="o">());</span>
<span class="lineno">30</span>     <span class="o">}</span>
<span class="lineno">31</span> 
<span class="lineno">32</span>     <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">33</span>   <span class="o">}</span></code></pre></div>

<p>看到我们熟悉的请求头了，之前的request一直都没有封装请求头，到现在才来干这件事，也是一种懒加载的方式嘛。从这几行代码中可以看出哪些是一个httpHeader所必须的字段：host、connection、Accept-Encoding、User-Agent，当然，如果有cookie的话也是要加上的</p>

<p>回到sendRequest，第7行尝试从cache中通过request获取一个候选的response，这个cache部署在okhttpClient中，默认是用它自己的一个DiskLruCache实现的，key是request的url的md5值，value则是response，里面有LinkedHashMap缓存以及磁盘缓存还有snapshot之类的，以后单独研究一下，现在知道它是个cache就行了</p>

<p>第13行，创建一个CacheStrategy：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="nf">Factory</span><span class="o">(</span><span class="kt">long</span> <span class="n">nowMillis</span><span class="o">,</span> <span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Response</span> <span class="n">cacheResponse</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>   <span class="k">this</span><span class="o">.</span><span class="na">nowMillis</span> <span class="o">=</span> <span class="n">nowMillis</span><span class="o">;</span>
<span class="lineno"> 3</span>   <span class="k">this</span><span class="o">.</span><span class="na">request</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
<span class="lineno"> 4</span>   <span class="k">this</span><span class="o">.</span><span class="na">cacheResponse</span> <span class="o">=</span> <span class="n">cacheResponse</span><span class="o">;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>   <span class="k">if</span> <span class="o">(</span><span class="n">cacheResponse</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>     <span class="n">Headers</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">cacheResponse</span><span class="o">.</span><span class="na">headers</span><span class="o">();</span>
<span class="lineno"> 8</span>     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="lineno"> 9</span>       <span class="n">String</span> <span class="n">fieldName</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="lineno">10</span>       <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="lineno">11</span>       <span class="k">if</span> <span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">servedDate</span> <span class="o">=</span> <span class="n">HttpDate</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="lineno">13</span>         <span class="n">servedDateString</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
<span class="lineno">14</span>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&quot;Expires&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">15</span>         <span class="n">expires</span> <span class="o">=</span> <span class="n">HttpDate</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="lineno">16</span>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&quot;Last-Modified&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">17</span>         <span class="n">lastModified</span> <span class="o">=</span> <span class="n">HttpDate</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="lineno">18</span>         <span class="n">lastModifiedString</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
<span class="lineno">19</span>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&quot;ETag&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">20</span>         <span class="n">etag</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
<span class="lineno">21</span>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&quot;Age&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">22</span>         <span class="n">ageSeconds</span> <span class="o">=</span> <span class="n">HeaderParser</span><span class="o">.</span><span class="na">parseSeconds</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
<span class="lineno">23</span>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">OkHeaders</span><span class="o">.</span><span class="na">SENT_MILLIS</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">24</span>         <span class="n">sentRequestMillis</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="lineno">25</span>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">OkHeaders</span><span class="o">.</span><span class="na">RECEIVED_MILLIS</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">26</span>         <span class="n">receivedResponseMillis</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
<span class="lineno">27</span>       <span class="o">}</span>
<span class="lineno">28</span>     <span class="o">}</span>
<span class="lineno">29</span>   <span class="o">}</span>
<span class="lineno">30</span> <span class="o">}</span>
<span class="lineno">31</span> 
<span class="lineno">32</span> <span class="cm">/**</span>
<span class="lineno">33</span> <span class="cm"> * Returns a strategy to satisfy {@code request} using the a cached response {@code response}.</span>
<span class="lineno">34</span> <span class="cm"> */</span>
<span class="lineno">35</span> <span class="kd">public</span> <span class="n">CacheStrategy</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">36</span>   <span class="n">CacheStrategy</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">getCandidate</span><span class="o">();</span>
<span class="lineno">37</span> 
<span class="lineno">38</span>   <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">networkRequest</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="na">cacheControl</span><span class="o">().</span><span class="na">onlyIfCached</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">39</span>     <span class="c1">// We&#39;re forbidden from using the network and the cache is insufficient.</span>
<span class="lineno">40</span>     <span class="k">return</span> <span class="k">new</span> <span class="nf">CacheStrategy</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="lineno">41</span>   <span class="o">}</span>
<span class="lineno">42</span> 
<span class="lineno">43</span>   <span class="k">return</span> <span class="n">candidate</span><span class="o">;</span>
<span class="lineno">44</span> <span class="o">}</span>
<span class="lineno">45</span> 
<span class="lineno">46</span>   <span class="kd">public</span> <span class="kd">final</span> <span class="n">Request</span> <span class="n">networkRequest</span><span class="o">;</span>
<span class="lineno">47</span> 
<span class="lineno">48</span>   <span class="cm">/** The cached response to return or validate; or null if this call doesn&#39;t use a cache. */</span>
<span class="lineno">49</span>   <span class="kd">public</span> <span class="kd">final</span> <span class="n">Response</span> <span class="n">cacheResponse</span><span class="o">;</span>
<span class="lineno">50</span> 
<span class="lineno">51</span>   <span class="kd">private</span> <span class="nf">CacheStrategy</span><span class="o">(</span><span class="n">Request</span> <span class="n">networkRequest</span><span class="o">,</span> <span class="n">Response</span> <span class="n">cacheResponse</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">52</span>     <span class="k">this</span><span class="o">.</span><span class="na">networkRequest</span> <span class="o">=</span> <span class="n">networkRequest</span><span class="o">;</span>
<span class="lineno">53</span>     <span class="k">this</span><span class="o">.</span><span class="na">cacheResponse</span> <span class="o">=</span> <span class="n">cacheResponse</span><span class="o">;</span>
<span class="lineno">54</span>   <span class="o">}</span></code></pre></div>

<p>factory里面除了保存一下request和当前的时间，还会提取cacheResponse里面的响应头信息，用来帮助以后判断这个cache的有效性，其中涉及到date、expires、last-modified等我们熟悉的字段;get方法会根据cacheResponse和request的特性来生成一个CacheStrategy，其中的networkRequest是否为null来判断是否使用网络来发送这个请求，cacheResponse是否为null来决定这个cache是否可用</p>

<p>再回到sendRequest的21行，如果cacheCandidate不可用，则会关闭它的body</p>

<p>26行，如果经过cacheStrategy的过滤，network和cache都不可用(说明在个request标明了only-if-cached)，就创建一个504的response返回</p>

<p>39行，如果这个cache可用，那么就根据这个cacheResponse和userRequest(最初传进来的request，没有加host等头部)创建给userResopnse并返回</p>

<p>以上都是跟cacheResponse有关的操作，接下来的就是正儿八经只能通过网络去发送请求了</p>

<p>首先进入视线的是52行的connect，终于要连接起来了好兴奋～：</p>

<div class="highlight"><pre><code class="java"><span class="lineno">1</span> <span class="kd">private</span> <span class="n">HttpStream</span> <span class="nf">connect</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RouteException</span><span class="o">,</span> <span class="n">RequestException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">2</span>     <span class="kt">boolean</span> <span class="n">doExtensiveHealthChecks</span> <span class="o">=</span> <span class="o">!</span><span class="n">networkRequest</span><span class="o">.</span><span class="na">method</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">);</span>
<span class="lineno">3</span>     <span class="k">return</span> <span class="n">streamAllocation</span><span class="o">.</span><span class="na">newStream</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">connectTimeoutMillis</span><span class="o">(),</span>
<span class="lineno">4</span>         <span class="n">client</span><span class="o">.</span><span class="na">readTimeoutMillis</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">writeTimeoutMillis</span><span class="o">(),</span>
<span class="lineno">5</span>         <span class="n">client</span><span class="o">.</span><span class="na">retryOnConnectionFailure</span><span class="o">(),</span> <span class="n">doExtensiveHealthChecks</span><span class="o">);</span>
<span class="lineno">6</span>   <span class="o">}</span></code></pre></div>

<p>啊，终于要给streamAllocation创建一个stream了：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="n">HttpStream</span> <span class="nf">newStream</span><span class="o">(</span><span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">writeTimeout</span><span class="o">,</span>
<span class="lineno"> 2</span>       <span class="kt">boolean</span> <span class="n">connectionRetryEnabled</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">doExtensiveHealthChecks</span><span class="o">)</span>
<span class="lineno"> 3</span>       <span class="kd">throws</span> <span class="n">RouteException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 4</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 5</span>       <span class="n">RealConnection</span> <span class="n">resultConnection</span> <span class="o">=</span> <span class="n">findHealthyConnection</span><span class="o">(</span><span class="n">connectTimeout</span><span class="o">,</span> <span class="n">readTimeout</span><span class="o">,</span>
<span class="lineno"> 6</span>           <span class="n">writeTimeout</span><span class="o">,</span> <span class="n">connectionRetryEnabled</span><span class="o">,</span> <span class="n">doExtensiveHealthChecks</span><span class="o">);</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>       <span class="n">HttpStream</span> <span class="n">resultStream</span><span class="o">;</span>
<span class="lineno"> 9</span>       <span class="k">if</span> <span class="o">(</span><span class="n">resultConnection</span><span class="o">.</span><span class="na">framedConnection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="n">resultStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Http2xStream</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">resultConnection</span><span class="o">.</span><span class="na">framedConnection</span><span class="o">);</span>
<span class="lineno">11</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">resultConnection</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="n">readTimeout</span><span class="o">);</span>
<span class="lineno">13</span>         <span class="n">resultConnection</span><span class="o">.</span><span class="na">source</span><span class="o">.</span><span class="na">timeout</span><span class="o">().</span><span class="na">timeout</span><span class="o">(</span><span class="n">readTimeout</span><span class="o">,</span> <span class="n">MILLISECONDS</span><span class="o">);</span>
<span class="lineno">14</span>         <span class="n">resultConnection</span><span class="o">.</span><span class="na">sink</span><span class="o">.</span><span class="na">timeout</span><span class="o">().</span><span class="na">timeout</span><span class="o">(</span><span class="n">writeTimeout</span><span class="o">,</span> <span class="n">MILLISECONDS</span><span class="o">);</span>
<span class="lineno">15</span>         <span class="n">resultStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Http1xStream</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">resultConnection</span><span class="o">.</span><span class="na">source</span><span class="o">,</span> <span class="n">resultConnection</span><span class="o">.</span><span class="na">sink</span><span class="o">);</span>
<span class="lineno">16</span>       <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>       <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>         <span class="n">stream</span> <span class="o">=</span> <span class="n">resultStream</span><span class="o">;</span>
<span class="lineno">20</span>         <span class="k">return</span> <span class="n">resultStream</span><span class="o">;</span>
<span class="lineno">21</span>       <span class="o">}</span>
<span class="lineno">22</span>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">23</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">RouteException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="lineno">24</span>     <span class="o">}</span>
<span class="lineno">25</span>   <span class="o">}</span></code></pre></div>

<p>RealConnection维护一个真实的socket，看看是怎么findHealthyConnection的：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Finds a connection and returns it if it is healthy. If it is unhealthy the process is repeated</span>
<span class="lineno"> 3</span> <span class="cm">   * until a healthy connection is found.</span>
<span class="lineno"> 4</span> <span class="cm">   */</span>
<span class="lineno"> 5</span>   <span class="kd">private</span> <span class="n">RealConnection</span> <span class="nf">findHealthyConnection</span><span class="o">(</span><span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeout</span><span class="o">,</span>
<span class="lineno"> 6</span>       <span class="kt">int</span> <span class="n">writeTimeout</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">connectionRetryEnabled</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">doExtensiveHealthChecks</span><span class="o">)</span>
<span class="lineno"> 7</span>       <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">RouteException</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>       <span class="n">RealConnection</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">findConnection</span><span class="o">(</span><span class="n">connectTimeout</span><span class="o">,</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="n">writeTimeout</span><span class="o">,</span>
<span class="lineno">10</span>           <span class="n">connectionRetryEnabled</span><span class="o">);</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>       <span class="c1">// If this is a brand new connection, we can skip the extensive health checks.</span>
<span class="lineno">13</span>       <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>         <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">successCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>           <span class="k">return</span> <span class="n">candidate</span><span class="o">;</span>
<span class="lineno">16</span>         <span class="o">}</span>
<span class="lineno">17</span>       <span class="o">}</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>       <span class="c1">// Otherwise do a potentially-slow check to confirm that the pooled connection is still good.</span>
<span class="lineno">20</span>       <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">isHealthy</span><span class="o">(</span><span class="n">doExtensiveHealthChecks</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">21</span>         <span class="k">return</span> <span class="n">candidate</span><span class="o">;</span>
<span class="lineno">22</span>       <span class="o">}</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>       <span class="n">connectionFailed</span><span class="o">(</span><span class="k">new</span> <span class="n">IOException</span><span class="o">());</span>
<span class="lineno">25</span>     <span class="o">}</span>
<span class="lineno">26</span>   <span class="o">}</span></code></pre></div>

<p>大体就是一个while循环，不断的通过findConnection去找一个connection，再根据它的可用性判断是否要用它<br />
那么还是要看看findConnection：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Returns a connection to host a new stream. This prefers the existing connection if it exists,</span>
<span class="lineno"> 3</span> <span class="cm">   * then the pool, finally building a new connection.</span>
<span class="lineno"> 4</span> <span class="cm">   */</span>
<span class="lineno"> 5</span>   <span class="kd">private</span> <span class="n">RealConnection</span> <span class="nf">findConnection</span><span class="o">(</span><span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">writeTimeout</span><span class="o">,</span>
<span class="lineno"> 6</span>       <span class="kt">boolean</span> <span class="n">connectionRetryEnabled</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">RouteException</span> <span class="o">{</span>
<span class="lineno"> 7</span>     <span class="n">Route</span> <span class="n">selectedRoute</span><span class="o">;</span>
<span class="lineno"> 8</span>     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>       <span class="k">if</span> <span class="o">(</span><span class="n">released</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;released&quot;</span><span class="o">);</span>
<span class="lineno">10</span>       <span class="k">if</span> <span class="o">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;stream != null&quot;</span><span class="o">);</span>
<span class="lineno">11</span>       <span class="k">if</span> <span class="o">(</span><span class="n">canceled</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Canceled&quot;</span><span class="o">);</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>       <span class="n">RealConnection</span> <span class="n">allocatedConnection</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">connection</span><span class="o">;</span>
<span class="lineno">14</span>       <span class="k">if</span> <span class="o">(</span><span class="n">allocatedConnection</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allocatedConnection</span><span class="o">.</span><span class="na">noNewStreams</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>         <span class="k">return</span> <span class="n">allocatedConnection</span><span class="o">;</span>
<span class="lineno">16</span>       <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>       <span class="c1">// Attempt to get a connection from the pool.</span>
<span class="lineno">19</span>       <span class="n">RealConnection</span> <span class="n">pooledConnection</span> <span class="o">=</span> <span class="n">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">connectionPool</span><span class="o">,</span> <span class="n">address</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="lineno">20</span>       <span class="k">if</span> <span class="o">(</span><span class="n">pooledConnection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">21</span>         <span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">=</span> <span class="n">pooledConnection</span><span class="o">;</span>
<span class="lineno">22</span>         <span class="k">return</span> <span class="n">pooledConnection</span><span class="o">;</span>
<span class="lineno">23</span>       <span class="o">}</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>       <span class="n">selectedRoute</span> <span class="o">=</span> <span class="n">route</span><span class="o">;</span>
<span class="lineno">26</span>     <span class="o">}</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="k">if</span> <span class="o">(</span><span class="n">selectedRoute</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">29</span>       <span class="n">selectedRoute</span> <span class="o">=</span> <span class="n">routeSelector</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="lineno">30</span>       <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">31</span>         <span class="n">route</span> <span class="o">=</span> <span class="n">selectedRoute</span><span class="o">;</span>
<span class="lineno">32</span>       <span class="o">}</span>
<span class="lineno">33</span>     <span class="o">}</span>
<span class="lineno">34</span>     <span class="n">RealConnection</span> <span class="n">newConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RealConnection</span><span class="o">(</span><span class="n">selectedRoute</span><span class="o">);</span>
<span class="lineno">35</span>     <span class="n">acquire</span><span class="o">(</span><span class="n">newConnection</span><span class="o">);</span>
<span class="lineno">36</span> 
<span class="lineno">37</span>     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">38</span>       <span class="n">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">connectionPool</span><span class="o">,</span> <span class="n">newConnection</span><span class="o">);</span>
<span class="lineno">39</span>       <span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">=</span> <span class="n">newConnection</span><span class="o">;</span>
<span class="lineno">40</span>       <span class="k">if</span> <span class="o">(</span><span class="n">canceled</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Canceled&quot;</span><span class="o">);</span>
<span class="lineno">41</span>     <span class="o">}</span>
<span class="lineno">42</span> 
<span class="lineno">43</span>     <span class="n">newConnection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">connectTimeout</span><span class="o">,</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="n">writeTimeout</span><span class="o">,</span> <span class="n">address</span><span class="o">.</span><span class="na">connectionSpecs</span><span class="o">(),</span>
<span class="lineno">44</span>         <span class="n">connectionRetryEnabled</span><span class="o">);</span>
<span class="lineno">45</span>     <span class="n">routeDatabase</span><span class="o">().</span><span class="na">connected</span><span class="o">(</span><span class="n">newConnection</span><span class="o">.</span><span class="na">route</span><span class="o">());</span>
<span class="lineno">46</span> 
<span class="lineno">47</span>     <span class="k">return</span> <span class="n">newConnection</span><span class="o">;</span>
<span class="lineno">48</span>   <span class="o">}</span></code></pre></div>

<p>19行会尝试从connectionPool中通过adress和this来获得一个connection，看看它干了什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="c1">//ConnectionPool</span>
<span class="lineno"> 2</span>   <span class="cm">/** Returns a recycled connection to {@code address}, or null if no such connection exists. */</span>
<span class="lineno"> 3</span>   <span class="n">RealConnection</span> <span class="nf">get</span><span class="o">(</span><span class="n">Address</span> <span class="n">address</span><span class="o">,</span> <span class="n">StreamAllocation</span> <span class="n">streamAllocation</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 4</span>     <span class="k">assert</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">holdsLock</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
<span class="lineno"> 5</span>     <span class="k">for</span> <span class="o">(</span><span class="n">RealConnection</span> <span class="n">connection</span> <span class="o">:</span> <span class="n">connections</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">allocations</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">connection</span><span class="o">.</span><span class="na">allocationLimit</span>
<span class="lineno"> 7</span>           <span class="o">&amp;&amp;</span> <span class="n">address</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">route</span><span class="o">().</span><span class="na">address</span><span class="o">)</span>
<span class="lineno"> 8</span>           <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">connection</span><span class="o">.</span><span class="na">noNewStreams</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>         <span class="n">streamAllocation</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
<span class="lineno">10</span>         <span class="k">return</span> <span class="n">connection</span><span class="o">;</span>
<span class="lineno">11</span>       <span class="o">}</span>
<span class="lineno">12</span>     <span class="o">}</span>
<span class="lineno">13</span>     <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">14</span>   <span class="o">}</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c1">//StreamAllocation</span>
<span class="lineno">17</span>   <span class="cm">/**</span>
<span class="lineno">18</span> <span class="cm">   * Use this allocation to hold {@code connection}. Each call to this must be paired with a call to</span>
<span class="lineno">19</span> <span class="cm">   * {@link #release} on the same connection.</span>
<span class="lineno">20</span> <span class="cm">   */</span>
<span class="lineno">21</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="n">RealConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">22</span>     <span class="n">connection</span><span class="o">.</span><span class="na">allocations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">));</span>
<span class="lineno">23</span>   <span class="o">}</span></code></pre></div>

<p>很简单，遍历自己的deque，找到与address匹配的connection，然后将streamAllocation加入到这个connection的allocations列表中<br />
因此我们可以验证connectionPool是一个存放connection的池子，顺带提一下刚才提到的StreamAllocation的release方法：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/** Remove this allocation from the connection&#39;s list of allocations. */</span>
<span class="lineno"> 2</span>   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">release</span><span class="o">(</span><span class="n">RealConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">allocations</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="lineno"> 4</span>       <span class="n">Reference</span><span class="o">&lt;</span><span class="n">StreamAllocation</span><span class="o">&gt;</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">allocations</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="lineno"> 5</span>       <span class="k">if</span> <span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>         <span class="n">connection</span><span class="o">.</span><span class="na">allocations</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="lineno"> 7</span>         <span class="k">return</span><span class="o">;</span>
<span class="lineno"> 8</span>       <span class="o">}</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span>     <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
<span class="lineno">11</span>   <span class="o">}</span></code></pre></div>

<p>其实就是在connection的allocations队列中删掉自己，因此我们可以知道，StreamAllocation关闭不并代表connection关闭，只是说断开了它持有的stream与connection的关系</p>

<p>回到findConnection，如果在ConnectionPool中找不到可用的connection，那只能在34行new一个RealConncetion了，并在35行把自己acquire到这个connection了。于此同时，还要把这个connection放到ConnectionPool中去，因为对当前address的连接，它是唯一的<br />
来看43行，这个newConnection终于要尝试去连接server了，激动：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">writeTimeout</span><span class="o">,</span>
<span class="lineno"> 2</span>       <span class="n">List</span><span class="o">&lt;</span><span class="n">ConnectionSpec</span><span class="o">&gt;</span> <span class="n">connectionSpecs</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">connectionRetryEnabled</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RouteException</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="c1">//blahblahblah</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="k">while</span> <span class="o">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 7</span>         <span class="n">rawSocket</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">DIRECT</span> <span class="o">||</span> <span class="n">proxy</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">==</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">HTTP</span>
<span class="lineno"> 8</span>             <span class="o">?</span> <span class="n">address</span><span class="o">.</span><span class="na">socketFactory</span><span class="o">().</span><span class="na">createSocket</span><span class="o">()</span>
<span class="lineno"> 9</span>             <span class="o">:</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
<span class="lineno">10</span>         <span class="n">connectSocket</span><span class="o">(</span><span class="n">connectTimeout</span><span class="o">,</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="n">writeTimeout</span><span class="o">,</span> <span class="n">connectionSpecSelector</span><span class="o">);</span>
<span class="lineno">11</span>     	<span class="c1">//blahblahblah</span>
<span class="lineno">12</span> 		<span class="o">}</span>
<span class="lineno">13</span> 	<span class="o">}</span>
<span class="lineno">14</span> <span class="o">}</span></code></pre></div>

<p>7行终于给rawSocket创建了对象，紧接着去connectionSocket：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/** Does all the work necessary to build a full HTTP or HTTPS connection on a raw socket. */</span>
<span class="lineno"> 2</span>   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">connectSocket</span><span class="o">(</span><span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">writeTimeout</span><span class="o">,</span>
<span class="lineno"> 3</span>       <span class="n">ConnectionSpecSelector</span> <span class="n">connectionSpecSelector</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 4</span>     <span class="n">rawSocket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="n">readTimeout</span><span class="o">);</span>
<span class="lineno"> 5</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="n">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">connectSocket</span><span class="o">(</span><span class="n">rawSocket</span><span class="o">,</span> <span class="n">route</span><span class="o">.</span><span class="na">socketAddress</span><span class="o">(),</span> <span class="n">connectTimeout</span><span class="o">);</span>
<span class="lineno"> 7</span>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ConnectException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConnectException</span><span class="o">(</span><span class="s">&quot;Failed to connect to &quot;</span> <span class="o">+</span> <span class="n">route</span><span class="o">.</span><span class="na">socketAddress</span><span class="o">());</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span>     <span class="n">source</span> <span class="o">=</span> <span class="n">Okio</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">Okio</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">rawSocket</span><span class="o">));</span>
<span class="lineno">11</span>     <span class="n">sink</span> <span class="o">=</span> <span class="n">Okio</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">Okio</span><span class="o">.</span><span class="na">sink</span><span class="o">(</span><span class="n">rawSocket</span><span class="o">));</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     <span class="k">if</span> <span class="o">(</span><span class="n">route</span><span class="o">.</span><span class="na">address</span><span class="o">().</span><span class="na">sslSocketFactory</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>       <span class="n">connectTls</span><span class="o">(</span><span class="n">readTimeout</span><span class="o">,</span> <span class="n">writeTimeout</span><span class="o">,</span> <span class="n">connectionSpecSelector</span><span class="o">);</span>
<span class="lineno">15</span>     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">16</span>       <span class="n">protocol</span> <span class="o">=</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">;</span>
<span class="lineno">17</span>       <span class="n">socket</span> <span class="o">=</span> <span class="n">rawSocket</span><span class="o">;</span>
<span class="lineno">18</span>     <span class="o">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>     <span class="k">if</span> <span class="o">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">SPDY_3</span> <span class="o">||</span> <span class="n">protocol</span> <span class="o">==</span> <span class="n">Protocol</span><span class="o">.</span><span class="na">HTTP_2</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">21</span>       <span class="n">socket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// Framed connection timeouts are set per-stream.</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>       <span class="n">FramedConnection</span> <span class="n">framedConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FramedConnection</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="lineno">24</span>           <span class="o">.</span><span class="na">socket</span><span class="o">(</span><span class="n">socket</span><span class="o">,</span> <span class="n">route</span><span class="o">.</span><span class="na">address</span><span class="o">().</span><span class="na">url</span><span class="o">().</span><span class="na">host</span><span class="o">(),</span> <span class="n">source</span><span class="o">,</span> <span class="n">sink</span><span class="o">)</span>
<span class="lineno">25</span>           <span class="o">.</span><span class="na">protocol</span><span class="o">(</span><span class="n">protocol</span><span class="o">)</span>
<span class="lineno">26</span>           <span class="o">.</span><span class="na">listener</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="lineno">27</span>           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">28</span>       <span class="n">framedConnection</span><span class="o">.</span><span class="na">sendConnectionPreface</span><span class="o">();</span>
<span class="lineno">29</span> 
<span class="lineno">30</span>       <span class="c1">// Only assign the framed connection once the preface has been sent successfully.</span>
<span class="lineno">31</span>       <span class="k">this</span><span class="o">.</span><span class="na">allocationLimit</span> <span class="o">=</span> <span class="n">framedConnection</span><span class="o">.</span><span class="na">maxConcurrentStreams</span><span class="o">();</span>
<span class="lineno">32</span>       <span class="k">this</span><span class="o">.</span><span class="na">framedConnection</span> <span class="o">=</span> <span class="n">framedConnection</span><span class="o">;</span>
<span class="lineno">33</span>     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">34</span>       <span class="k">this</span><span class="o">.</span><span class="na">allocationLimit</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="lineno">35</span>     <span class="o">}</span>
<span class="lineno">36</span>   <span class="o">}</span></code></pre></div>

<p>看第6行，这是最里面了，终于要用我们的rawSocket小朋友去执行connection操作了：</p>

<div class="highlight"><pre><code class="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connectSocket</span><span class="o">(</span><span class="n">Socket</span> <span class="n">socket</span><span class="o">,</span> <span class="n">InetSocketAddress</span> <span class="n">address</span><span class="o">,</span>
<span class="lineno">2</span>       <span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">3</span>     <span class="n">socket</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">connectTimeout</span><span class="o">);</span>
<span class="lineno">4</span>   <span class="o">}</span></code></pre></div>

<p>剩下的就由java底层接管了，我们分析到这里就可以了<br />
回到connectSocket，source是一个<a href="https://github.com/square/okio">Okio</a>中用于读的buffer，而sink是用来写的buffer<br />
13、14会判断是否配置了SSL安全协议，如果有的话会进入ssl协议的连接、验证等一系列工作<br />
如果协议是SPDY3或者HTTP2.0的话，就支持全双共通信，因此在20行还要建立一个framedConnection来支持这种操作，并且ssl这种应用层协议使用的是socket，而底层tcp使用的是之前创建的rawSocket(最终socket也会指向rawSocket，这样对于上层来说，它们只需要操作socket就行了)</p>

<p>一连串的调用结束了，我们回到findHealthyConnection(可能需要一点耐心～)的20行，会检查这个candidate是否健康，那无非就是判断里面的socket是否关闭是否timeout</p>

<p>回到StreamAllocation(耐心…)， 第9行，会看看通过ssl创建的framedConnection来创建不同的stream，它具体用来做什么的等下再看</p>

<p>回到HttpEngine的sendRequest，这个stream赋值给了httpStream，现在的状态已经是把连接建立起来了，接下来就要写入请求头部了，看到第55行，进入这个方法：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * If the caller&#39;s control flow writes the request body, we need to create that stream</span>
<span class="lineno"> 3</span> <span class="cm">   * immediately. And that means we need to immediately write the request headers, so we can</span>
<span class="lineno"> 4</span> <span class="cm">   * start streaming the request body. (We may already have a request body if we&#39;re retrying a</span>
<span class="lineno"> 5</span> <span class="cm">   * failed POST.)</span>
<span class="lineno"> 6</span> <span class="cm">   */</span>
<span class="lineno"> 7</span>   <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">writeRequestHeadersEagerly</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="k">return</span> <span class="n">callerWritesRequestBody</span>
<span class="lineno"> 9</span>         <span class="o">&amp;&amp;</span> <span class="n">permitsRequestBody</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">)</span>
<span class="lineno">10</span>         <span class="o">&amp;&amp;</span> <span class="n">requestBodyOut</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">11</span>   <span class="o">}</span></code></pre></div>

<p>一开始就判断callerWritesRequestBody这个boolean值，但是我们在新建第一个httpEngine的时候把它设为false，因此什么也不会做。</p>

<p>好了，sendRequest木有了， 我们回到了sendRequest里面，把代码再贴出来回顾一下：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>       <span class="k">if</span> <span class="o">(</span><span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>         <span class="n">engine</span><span class="o">.</span><span class="na">releaseStreamAllocation</span><span class="o">();</span>
<span class="lineno"> 4</span>         <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Canceled&quot;</span><span class="o">);</span>
<span class="lineno"> 5</span>       <span class="o">}</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>       <span class="kt">boolean</span> <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 8</span>       <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 9</span>         <span class="n">engine</span><span class="o">.</span><span class="na">sendRequest</span><span class="o">();</span>
<span class="lineno">10</span>         <span class="n">engine</span><span class="o">.</span><span class="na">readResponse</span><span class="o">();</span>
<span class="lineno">11</span>         <span class="n">releaseConnection</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span></code></pre></div>

<p>发现没有，刚才我们分析的一大摞关于sendRequest的，但到头来好像就干了connect这一件事情件事，header和body的数据是什么时候发呢？会不会在readResponse里面做这些事呢？let‘s find out，咱们先看一部分：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Flushes the remaining request header and body, parses the HTTP response headers and starts</span>
<span class="lineno"> 3</span> <span class="cm">   * reading the HTTP response body if it exists.</span>
<span class="lineno"> 4</span> <span class="cm">   */</span>
<span class="lineno"> 5</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readResponse</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 6</span>     <span class="k">if</span> <span class="o">(</span><span class="n">userResponse</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>       <span class="k">return</span><span class="o">;</span> <span class="c1">// Already ready.</span>
<span class="lineno"> 8</span>     <span class="o">}</span>
<span class="lineno"> 9</span>     <span class="k">if</span> <span class="o">(</span><span class="n">networkRequest</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cacheResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;call sendRequest() first!&quot;</span><span class="o">);</span>
<span class="lineno">11</span>     <span class="o">}</span>
<span class="lineno">12</span>     <span class="k">if</span> <span class="o">(</span><span class="n">networkRequest</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">13</span>       <span class="k">return</span><span class="o">;</span> <span class="c1">// No network response to read.</span>
<span class="lineno">14</span>     <span class="o">}</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>     <span class="n">Response</span> <span class="n">networkResponse</span><span class="o">;</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="k">if</span> <span class="o">(</span><span class="n">forWebSocket</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>       <span class="n">httpStream</span><span class="o">.</span><span class="na">writeRequestHeaders</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">);</span>
<span class="lineno">20</span>       <span class="n">networkResponse</span> <span class="o">=</span> <span class="n">readNetworkResponse</span><span class="o">();</span>
<span class="lineno">21</span>     <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">callerWritesRequestBody</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">22</span>       <span class="n">networkResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkInterceptorChain</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">networkRequest</span><span class="o">,</span>
<span class="lineno">23</span>           <span class="n">streamAllocation</span><span class="o">.</span><span class="na">connection</span><span class="o">()).</span><span class="na">proceed</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">);</span>
<span class="lineno">24</span>     <span class="o">}</span></code></pre></div>

<p>看到方法注释我就放心了，还记得我们之前第一次构造httpEngine的时候传入的callerWritesRequestBody为false吗，这里就通过NetworkInterceptorChain.poceed来获取response：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Response</span> <span class="n">proceed</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>       <span class="n">calls</span><span class="o">++;</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>       <span class="c1">// something about intercepor chain</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>       <span class="n">httpStream</span><span class="o">.</span><span class="na">writeRequestHeaders</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>       <span class="c1">//Update the networkRequest with the possibly updated interceptor request.</span>
<span class="lineno"> 9</span>       <span class="n">networkRequest</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>       <span class="k">if</span> <span class="o">(</span><span class="n">permitsRequestBody</span><span class="o">(</span><span class="n">request</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="n">Sink</span> <span class="n">requestBodyOut</span> <span class="o">=</span> <span class="n">httpStream</span><span class="o">.</span><span class="na">createRequestBody</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">contentLength</span><span class="o">());</span>
<span class="lineno">13</span>         <span class="n">BufferedSink</span> <span class="n">bufferedRequestBody</span> <span class="o">=</span> <span class="n">Okio</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">requestBodyOut</span><span class="o">);</span>
<span class="lineno">14</span>         <span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">writeTo</span><span class="o">(</span><span class="n">bufferedRequestBody</span><span class="o">);</span>
<span class="lineno">15</span>         <span class="n">bufferedRequestBody</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="lineno">16</span>       <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>       <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">readNetworkResponse</span><span class="o">();</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>       <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">code</span><span class="o">();</span>
<span class="lineno">21</span>       <span class="k">if</span> <span class="o">((</span><span class="n">code</span> <span class="o">==</span> <span class="mi">204</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">205</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">contentLength</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">22</span>         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ProtocolException</span><span class="o">(</span>
<span class="lineno">23</span>             <span class="s">&quot;HTTP &quot;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s">&quot; had non-zero Content-Length: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">contentLength</span><span class="o">());</span>
<span class="lineno">24</span>       <span class="o">}</span>
<span class="lineno">25</span> 
<span class="lineno">26</span>       <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="lineno">27</span>     <span class="o">}</span>
<span class="lineno">28</span>   <span class="o">}</span></code></pre></div>

<p>我们跳过前面有关于chain和intercepor的内容，啊哈，到了第6行，终于好像要发送header了呢：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Prepares the HTTP headers and sends them to the server.</span>
<span class="lineno"> 3</span> <span class="cm">   *</span>
<span class="lineno"> 4</span> <span class="cm">   * &lt;p&gt;For streaming requests with a body, headers must be prepared &lt;strong&gt;before&lt;/strong&gt; the</span>
<span class="lineno"> 5</span> <span class="cm">   * output stream has been written to. Otherwise the body would need to be buffered!</span>
<span class="lineno"> 6</span> <span class="cm">   *</span>
<span class="lineno"> 7</span> <span class="cm">   * &lt;p&gt;For non-streaming requests with a body, headers must be prepared &lt;strong&gt;after&lt;/strong&gt; the</span>
<span class="lineno"> 8</span> <span class="cm">   * output stream has been written to and closed. This ensures that the {@code Content-Length}</span>
<span class="lineno"> 9</span> <span class="cm">   * header field receives the proper value.</span>
<span class="lineno">10</span> <span class="cm">   */</span>
<span class="lineno">11</span>   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">writeRequestHeaders</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">12</span>     <span class="n">httpEngine</span><span class="o">.</span><span class="na">writingRequestHeaders</span><span class="o">();</span>
<span class="lineno">13</span>     <span class="n">String</span> <span class="n">requestLine</span> <span class="o">=</span> <span class="n">RequestLine</span><span class="o">.</span><span class="na">get</span><span class="o">(</span>
<span class="lineno">14</span>         <span class="n">request</span><span class="o">,</span> <span class="n">httpEngine</span><span class="o">.</span><span class="na">getConnection</span><span class="o">().</span><span class="na">route</span><span class="o">().</span><span class="na">proxy</span><span class="o">().</span><span class="na">type</span><span class="o">());</span>
<span class="lineno">15</span>     <span class="n">writeRequest</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">headers</span><span class="o">(),</span> <span class="n">requestLine</span><span class="o">);</span>
<span class="lineno">16</span>   <span class="o">}</span></code></pre></div>

<p>我们看看这么获得requestLine的：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">Type</span> <span class="n">proxyType</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
<span class="lineno"> 3</span>     <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">());</span>
<span class="lineno"> 4</span>     <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39; &#39;</span><span class="o">);</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="k">if</span> <span class="o">(</span><span class="n">includeAuthorityInRequestLine</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">proxyType</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno"> 7</span>       <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">url</span><span class="o">());</span>
<span class="lineno"> 8</span>     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno"> 9</span>       <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">requestPath</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">url</span><span class="o">()));</span>
<span class="lineno">10</span>     <span class="o">}</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; HTTP/1.1&quot;</span><span class="o">);</span>
<span class="lineno">13</span>     <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="lineno">14</span>   <span class="o">}</span></code></pre></div>

<p>熟悉的身影，我们分析的Http1xStream，那么自然版本号就是HTTP/1.1了，返回一个请求行的string<br />
再看writeRequest：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/** Returns bytes of a request header for sending on an HTTP transport. */</span>
<span class="lineno"> 2</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeRequest</span><span class="o">(</span><span class="n">Headers</span> <span class="n">headers</span><span class="o">,</span> <span class="n">String</span> <span class="n">requestLine</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_IDLE</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&quot;state: &quot;</span> <span class="o">+</span> <span class="n">state</span><span class="o">);</span>
<span class="lineno"> 4</span>     <span class="n">sink</span><span class="o">.</span><span class="na">writeUtf8</span><span class="o">(</span><span class="n">requestLine</span><span class="o">).</span><span class="na">writeUtf8</span><span class="o">(</span><span class="s">&quot;\r\n&quot;</span><span class="o">);</span>
<span class="lineno"> 5</span>     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="lineno"> 6</span>       <span class="n">sink</span><span class="o">.</span><span class="na">writeUtf8</span><span class="o">(</span><span class="n">headers</span><span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
<span class="lineno"> 7</span>           <span class="o">.</span><span class="na">writeUtf8</span><span class="o">(</span><span class="s">&quot;: &quot;</span><span class="o">)</span>
<span class="lineno"> 8</span>           <span class="o">.</span><span class="na">writeUtf8</span><span class="o">(</span><span class="n">headers</span><span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
<span class="lineno"> 9</span>           <span class="o">.</span><span class="na">writeUtf8</span><span class="o">(</span><span class="s">&quot;\r\n&quot;</span><span class="o">);</span>
<span class="lineno">10</span>     <span class="o">}</span>
<span class="lineno">11</span>     <span class="n">sink</span><span class="o">.</span><span class="na">writeUtf8</span><span class="o">(</span><span class="s">&quot;\r\n&quot;</span><span class="o">);</span>
<span class="lineno">12</span>     <span class="n">state</span> <span class="o">=</span> <span class="n">STATE_OPEN_REQUEST_BODY</span><span class="o">;</span>
<span class="lineno">13</span>   <span class="o">}</span></code></pre></div>

<p>激动人心的时刻来了，看到先通过sink写入请求行(当然了，肯定是要把string转为byte的)，在一行一行的写入header，最后会多加一个CRLF，这就把我们熟悉的请求头给拼出来并发出去了～
搞了半天是在这里才真正发出请求头啊<br />
回到proceed中11行，会先通过request请求方法判断是否允许有body并且body也不能为空，都满足的话，调用httpStream的createRequestBody：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Sink</span> <span class="n">createRequestBody</span><span class="o">(</span><span class="n">Request</span> <span class="n">request</span><span class="o">,</span> <span class="kt">long</span> <span class="n">contentLength</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="k">if</span> <span class="o">(</span><span class="s">&quot;chunked&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="o">)))</span> <span class="o">{</span>
<span class="lineno"> 3</span>       <span class="c1">// Stream a request body of unknown length.</span>
<span class="lineno"> 4</span>       <span class="k">return</span> <span class="nf">newChunkedSink</span><span class="o">();</span>
<span class="lineno"> 5</span>     <span class="o">}</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>       <span class="c1">// Stream a request body of a known length.</span>
<span class="lineno"> 9</span>       <span class="k">return</span> <span class="nf">newFixedLengthSink</span><span class="o">(</span><span class="n">contentLength</span><span class="o">);</span>
<span class="lineno">10</span>     <span class="o">}</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
<span class="lineno">13</span>         <span class="s">&quot;Cannot stream a request body without chunked encoding or a known content length!&quot;</span><span class="o">);</span>
<span class="lineno">14</span>   <span class="o">}</span></code></pre></div>

<p>在这里会检查header中有没有设置transfer-encoding：chunked，设置这个属性代表使用分块技术传递数据，如果数据量很大可以避免分配超大的buffer，也可以在发送不确定长度的数据的时候使用; 如果没设就返回一个contentLength长度的sink接口</p>

<p>完了后，会通过Okio创建一个用来发送requestBody的buffer，然后request.body().writeTo(bufferedRequestBody)，趁此机会我们可以看看一个RequestBody是怎么创建的：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/** Returns a new request body that transmits {@code content}. */</span>
<span class="lineno"> 2</span>   <span class="kd">public</span> <span class="kd">static</span> <span class="n">RequestBody</span> <span class="nf">create</span><span class="o">(</span><span class="kd">final</span> <span class="n">MediaType</span> <span class="n">contentType</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">,</span>
<span class="lineno"> 3</span>       <span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">byteCount</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 4</span>     <span class="k">if</span> <span class="o">(</span><span class="n">content</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&quot;content == null&quot;</span><span class="o">);</span>
<span class="lineno"> 5</span>     <span class="n">Util</span><span class="o">.</span><span class="na">checkOffsetAndCount</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">byteCount</span><span class="o">);</span>
<span class="lineno"> 6</span>     <span class="k">return</span> <span class="k">new</span> <span class="nf">RequestBody</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 7</span>       <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">MediaType</span> <span class="n">contentType</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="k">return</span> <span class="n">contentType</span><span class="o">;</span>
<span class="lineno"> 9</span>       <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>       <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">long</span> <span class="n">contentLength</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="k">return</span> <span class="n">byteCount</span><span class="o">;</span>
<span class="lineno">13</span>       <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>       <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">writeTo</span><span class="o">(</span><span class="n">BufferedSink</span> <span class="n">sink</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">16</span>         <span class="n">sink</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">byteCount</span><span class="o">);</span>
<span class="lineno">17</span>       <span class="o">}</span>
<span class="lineno">18</span>     <span class="o">};</span>
<span class="lineno">19</span>   <span class="o">}</span></code></pre></div>

<p>到此，<font color="red">header和body都发送完毕了</font>，好欣慰，终于……..等一下，后面还有response呢！！！我们现在是在readResponse的NetworkInterceptorChain的proceed方法里啊，咱们写完了body之后紧接着的18行就是readNetworkResponse了：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="n">Response</span> <span class="nf">readNetworkResponse</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">httpStream</span><span class="o">.</span><span class="na">finishRequest</span><span class="o">();</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>     <span class="n">Response</span> <span class="n">networkResponse</span> <span class="o">=</span> <span class="n">httpStream</span><span class="o">.</span><span class="na">readResponseHeaders</span><span class="o">()</span>
<span class="lineno"> 5</span>         <span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">networkRequest</span><span class="o">)</span>
<span class="lineno"> 6</span>         <span class="o">.</span><span class="na">handshake</span><span class="o">(</span><span class="n">streamAllocation</span><span class="o">.</span><span class="na">connection</span><span class="o">().</span><span class="na">handshake</span><span class="o">())</span>
<span class="lineno"> 7</span>         <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">OkHeaders</span><span class="o">.</span><span class="na">SENT_MILLIS</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">sentRequestMillis</span><span class="o">))</span>
<span class="lineno"> 8</span>         <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">OkHeaders</span><span class="o">.</span><span class="na">RECEIVED_MILLIS</span><span class="o">,</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()))</span>
<span class="lineno"> 9</span>         <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">if</span> <span class="o">(!</span><span class="n">forWebSocket</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>       <span class="n">networkResponse</span> <span class="o">=</span> <span class="n">networkResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
<span class="lineno">13</span>           <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">httpStream</span><span class="o">.</span><span class="na">openResponseBody</span><span class="o">(</span><span class="n">networkResponse</span><span class="o">))</span>
<span class="lineno">14</span>           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">15</span>     <span class="o">}</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="k">if</span> <span class="o">(</span><span class="s">&quot;close&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">networkResponse</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Connection&quot;</span><span class="o">))</span>
<span class="lineno">18</span>         <span class="o">||</span> <span class="s">&quot;close&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">networkResponse</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Connection&quot;</span><span class="o">)))</span> <span class="o">{</span>
<span class="lineno">19</span>       <span class="n">streamAllocation</span><span class="o">.</span><span class="na">noNewStreams</span><span class="o">();</span>
<span class="lineno">20</span>     <span class="o">}</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="k">return</span> <span class="n">networkResponse</span><span class="o">;</span>
<span class="lineno">23</span>   <span class="o">}</span></code></pre></div>

<ul>
  <li>
    <p>finishRequest干的就是吧sink里面的数据给flush出去</p>
  </li>
  <li>
    <p>紧接着会获取响应报头</p>
  </li>
  <li>
    <p>如果不是WebSocket就接受响应body</p>
  </li>
  <li>
    <p>最后看看是否要关闭这个stream</p>
  </li>
</ul>

<p>我们先来看看怎么读取响应报头的：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Response</span><span class="o">.</span><span class="na">Builder</span> <span class="n">readResponseHeaders</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="k">return</span> <span class="nf">readResponse</span><span class="o">();</span>
<span class="lineno"> 3</span>   <span class="o">}</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>   <span class="cm">/** Parses bytes of a response header from an HTTP transport. */</span>
<span class="lineno"> 7</span>   <span class="kd">public</span> <span class="n">Response</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">readResponse</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 9</span>       <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="n">StatusLine</span> <span class="n">statusLine</span> <span class="o">=</span> <span class="n">StatusLine</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">readUtf8LineStrict</span><span class="o">());</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>         <span class="n">Response</span><span class="o">.</span><span class="na">Builder</span> <span class="n">responseBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Response</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
<span class="lineno">13</span>             <span class="o">.</span><span class="na">protocol</span><span class="o">(</span><span class="n">statusLine</span><span class="o">.</span><span class="na">protocol</span><span class="o">)</span>
<span class="lineno">14</span>             <span class="o">.</span><span class="na">code</span><span class="o">(</span><span class="n">statusLine</span><span class="o">.</span><span class="na">code</span><span class="o">)</span>
<span class="lineno">15</span>             <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="n">statusLine</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
<span class="lineno">16</span>             <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">readHeaders</span><span class="o">());</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>         <span class="k">if</span> <span class="o">(</span><span class="n">statusLine</span><span class="o">.</span><span class="na">code</span> <span class="o">!=</span> <span class="n">HTTP_CONTINUE</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>           <span class="n">state</span> <span class="o">=</span> <span class="n">STATE_OPEN_RESPONSE_BODY</span><span class="o">;</span>
<span class="lineno">20</span>           <span class="k">return</span> <span class="n">responseBuilder</span><span class="o">;</span>
<span class="lineno">21</span>         <span class="o">}</span>
<span class="lineno">22</span>       <span class="o">}</span>
<span class="lineno">23</span>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">EOFException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">24</span>     <span class="c1">//blahblahblah</span>
<span class="lineno">25</span>   <span class="o">}</span></code></pre></div>

<p>source.readUtf8LineStrict就是读到“\n”或者“\r\n”结束，可以看<a href="https://github.com/square/okio/blob/master/okio/src/main/java/okio/BufferedSource.java">Okio BufferedSource</a><br />
然后再把它解析成状态行，也就是protocol、code、message这三个参数，最好还要readHeaders()：</p>

<div class="highlight"><pre><code class="java"><span class="lineno">1</span> <span class="cm">/** Reads headers or trailers. */</span>
<span class="lineno">2</span>   <span class="kd">public</span> <span class="n">Headers</span> <span class="nf">readHeaders</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">3</span>     <span class="n">Headers</span><span class="o">.</span><span class="na">Builder</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Headers</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
<span class="lineno">4</span>     <span class="c1">// parse the result headers until the first blank line</span>
<span class="lineno">5</span>     <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">line</span><span class="o">;</span> <span class="o">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">readUtf8LineStrict</span><span class="o">()).</span><span class="na">length</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
<span class="lineno">6</span>       <span class="n">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">addLenient</span><span class="o">(</span><span class="n">headers</span><span class="o">,</span> <span class="n">line</span><span class="o">);</span>
<span class="lineno">7</span>     <span class="o">}</span>
<span class="lineno">8</span>     <span class="k">return</span> <span class="n">headers</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">9</span>   <span class="o">}</span></code></pre></div>

<p>同样是一行一行的读入，直到空行CLRF，看看如何根据这些string构造headers的：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm"> * Add a header line without any validation. Only appropriate for headers from the remote peer</span>
<span class="lineno"> 3</span> <span class="cm"> * or cache.</span>
<span class="lineno"> 4</span> <span class="cm"> */</span>
<span class="lineno"> 5</span> <span class="n">Builder</span> <span class="nf">addLenient</span><span class="o">(</span><span class="n">String</span> <span class="n">line</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>   <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="lineno"> 7</span>   <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="k">return</span> <span class="nf">addLenient</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">),</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
<span class="lineno"> 9</span>   <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;:&quot;</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">10</span>     <span class="c1">// Work around empty header names and header names that start with a</span>
<span class="lineno">11</span>     <span class="c1">// colon (created by old broken SPDY versions of the response cache).</span>
<span class="lineno">12</span>     <span class="k">return</span> <span class="nf">addLenient</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">line</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span> <span class="c1">// Empty header name.</span>
<span class="lineno">13</span>   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">14</span>     <span class="k">return</span> <span class="nf">addLenient</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">line</span><span class="o">);</span> <span class="c1">// No header name.</span>
<span class="lineno">15</span>   <span class="o">}</span>
<span class="lineno">16</span> <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="cm">/**</span>
<span class="lineno">19</span> <span class="cm"> * Add a field with the specified value without any validation. Only appropriate for headers</span>
<span class="lineno">20</span> <span class="cm"> * from the remote peer or cache.</span>
<span class="lineno">21</span> <span class="cm"> */</span>
<span class="lineno">22</span> <span class="n">Builder</span> <span class="nf">addLenient</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">23</span>   <span class="n">namesAndValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="lineno">24</span>   <span class="n">namesAndValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
<span class="lineno">25</span>   <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="lineno">26</span> <span class="o">}</span></code></pre></div>

<p>不解释了，很简单，这样response header就构造完毕了</p>

<p>接下来回到readNetworkResponse来看body是怎么拿的，看httpStream.openResponseBody(networkResponse))</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">ResponseBody</span> <span class="n">openResponseBody</span><span class="o">(</span><span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">Source</span> <span class="n">source</span> <span class="o">=</span> <span class="n">getTransferStream</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
<span class="lineno"> 3</span>     <span class="k">return</span> <span class="k">new</span> <span class="nf">RealResponseBody</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">(),</span> <span class="n">Okio</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
<span class="lineno"> 4</span>   <span class="o">}</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>   <span class="kd">private</span> <span class="n">Source</span> <span class="nf">getTransferStream</span><span class="o">(</span><span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 7</span>     <span class="k">if</span> <span class="o">(!</span><span class="n">HttpEngine</span><span class="o">.</span><span class="na">hasBody</span><span class="o">(</span><span class="n">response</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno"> 8</span>       <span class="k">return</span> <span class="nf">newFixedLengthSource</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="k">if</span> <span class="o">(</span><span class="s">&quot;chunked&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="o">)))</span> <span class="o">{</span>
<span class="lineno">12</span>       <span class="k">return</span> <span class="nf">newChunkedSource</span><span class="o">(</span><span class="n">httpEngine</span><span class="o">);</span>
<span class="lineno">13</span>     <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>     <span class="kt">long</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">OkHeaders</span><span class="o">.</span><span class="na">contentLength</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
<span class="lineno">16</span>     <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">17</span>       <span class="k">return</span> <span class="nf">newFixedLengthSource</span><span class="o">(</span><span class="n">contentLength</span><span class="o">);</span>
<span class="lineno">18</span>     <span class="o">}</span>
<span class="lineno">19</span>   <span class="o">}</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>   <span class="kd">public</span> <span class="nf">RealResponseBody</span><span class="o">(</span><span class="n">Headers</span> <span class="n">headers</span><span class="o">,</span> <span class="n">BufferedSource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">22</span>     <span class="k">this</span><span class="o">.</span><span class="na">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">;</span>
<span class="lineno">23</span>     <span class="k">this</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>
<span class="lineno">24</span>   <span class="o">}</span></code></pre></div>

<ul>
  <li>
    <p>首先通过getTransferStream根据response.header的信息，创建一个合适的source，之前也说过了，这是用来读取数据的</p>
  </li>
  <li>
    <p>然后同样是通过Okio用这个source创建一个buffer来接收数据</p>
  </li>
  <li>
    <p>最后new一个RealResponseBody，这时候数据已经在BufferedSource里了</p>
  </li>
</ul>

<p>回到readNetworkResponse，根据header判断没有后续事项，就可以触发streamAllocation.noNewStreams()，最终调用deallocate：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Releases resources held by this allocation. If sufficient resources are allocated, the</span>
<span class="lineno"> 3</span> <span class="cm">   * connection will be detached or closed.</span>
<span class="lineno"> 4</span> <span class="cm">   */</span>
<span class="lineno"> 5</span>   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">deallocate</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">noNewStreams</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">released</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">streamFinished</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>     <span class="n">RealConnection</span> <span class="n">connectionToClose</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">connectionPool</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>       <span class="k">if</span> <span class="o">(</span><span class="n">streamFinished</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>         <span class="k">this</span><span class="o">.</span><span class="na">stream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">10</span>       <span class="o">}</span>
<span class="lineno">11</span>       <span class="k">if</span> <span class="o">(</span><span class="n">released</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="k">this</span><span class="o">.</span><span class="na">released</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">13</span>       <span class="o">}</span>
<span class="lineno">14</span>       <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>         <span class="k">if</span> <span class="o">(</span><span class="n">noNewStreams</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">16</span>           <span class="n">connection</span><span class="o">.</span><span class="na">noNewStreams</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">17</span>         <span class="o">}</span>
<span class="lineno">18</span>         <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">stream</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">released</span> <span class="o">||</span> <span class="n">connection</span><span class="o">.</span><span class="na">noNewStreams</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">19</span>           <span class="n">release</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
<span class="lineno">20</span>           <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">allocations</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">21</span>             <span class="n">connection</span><span class="o">.</span><span class="na">idleAtNanos</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="lineno">22</span>             <span class="k">if</span> <span class="o">(</span><span class="n">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">connectionBecameIdle</span><span class="o">(</span><span class="n">connectionPool</span><span class="o">,</span> <span class="n">connection</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">23</span>               <span class="n">connectionToClose</span> <span class="o">=</span> <span class="n">connection</span><span class="o">;</span>
<span class="lineno">24</span>             <span class="o">}</span>
<span class="lineno">25</span>           <span class="o">}</span>
<span class="lineno">26</span>           <span class="n">connection</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">27</span>         <span class="o">}</span>
<span class="lineno">28</span>       <span class="o">}</span>
<span class="lineno">29</span>     <span class="o">}</span>
<span class="lineno">30</span>     <span class="k">if</span> <span class="o">(</span><span class="n">connectionToClose</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">31</span>       <span class="n">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">connectionToClose</span><span class="o">.</span><span class="na">socket</span><span class="o">());</span>
<span class="lineno">32</span>     <span class="o">}</span>
<span class="lineno">33</span>   <span class="o">}</span></code></pre></div>

<p>它会把自己持有的stream释放，并且把它使用的connection释放，这个connection还会看看还有没有别的stream在用它，如果没有，去connectionPool里看看还有没有在排队的stream需要这个connection，都不满足的话就关闭这个socket，还蛮残忍的是不是</p>

<p>好了，我们从readNetworkResponse返回，再从proceed返回，回到了readResponse中，补完之前给出的一半代码：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="n">receiveHeaders</span><span class="o">(</span><span class="n">networkResponse</span><span class="o">.</span><span class="na">headers</span><span class="o">());</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="c1">// If we have a cache response too, then we&#39;re doing a conditional get.</span>
<span class="lineno"> 4</span>     <span class="k">if</span> <span class="o">(</span><span class="n">cacheResponse</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span>       <span class="k">if</span> <span class="o">(</span><span class="n">validate</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">,</span> <span class="n">networkResponse</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno"> 6</span>         <span class="n">userResponse</span> <span class="o">=</span> <span class="n">cacheResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
<span class="lineno"> 7</span>             <span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">userRequest</span><span class="o">)</span>
<span class="lineno"> 8</span>             <span class="o">.</span><span class="na">priorResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">priorResponse</span><span class="o">))</span>
<span class="lineno"> 9</span>             <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">combine</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">.</span><span class="na">headers</span><span class="o">(),</span> <span class="n">networkResponse</span><span class="o">.</span><span class="na">headers</span><span class="o">()))</span>
<span class="lineno">10</span>             <span class="o">.</span><span class="na">cacheResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">))</span>
<span class="lineno">11</span>             <span class="o">.</span><span class="na">networkResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">networkResponse</span><span class="o">))</span>
<span class="lineno">12</span>             <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">13</span>         <span class="n">networkResponse</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
<span class="lineno">14</span>         <span class="n">releaseStreamAllocation</span><span class="o">();</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>         <span class="c1">// Update the cache after combining headers but before stripping the</span>
<span class="lineno">17</span>         <span class="c1">// Content-Encoding header (as performed by initContentStream()).</span>
<span class="lineno">18</span>         <span class="n">InternalCache</span> <span class="n">responseCache</span> <span class="o">=</span> <span class="n">Internal</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">internalCache</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
<span class="lineno">19</span>         <span class="n">responseCache</span><span class="o">.</span><span class="na">trackConditionalCacheHit</span><span class="o">();</span>
<span class="lineno">20</span>         <span class="n">responseCache</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">,</span> <span class="n">stripBody</span><span class="o">(</span><span class="n">userResponse</span><span class="o">));</span>
<span class="lineno">21</span>         <span class="n">userResponse</span> <span class="o">=</span> <span class="n">unzip</span><span class="o">(</span><span class="n">userResponse</span><span class="o">);</span>
<span class="lineno">22</span>         <span class="k">return</span><span class="o">;</span>
<span class="lineno">23</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">24</span>         <span class="n">closeQuietly</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">.</span><span class="na">body</span><span class="o">());</span>
<span class="lineno">25</span>       <span class="o">}</span>
<span class="lineno">26</span>     <span class="o">}</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>     <span class="n">userResponse</span> <span class="o">=</span> <span class="n">networkResponse</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
<span class="lineno">29</span>         <span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">userRequest</span><span class="o">)</span>
<span class="lineno">30</span>         <span class="o">.</span><span class="na">priorResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">priorResponse</span><span class="o">))</span>
<span class="lineno">31</span>         <span class="o">.</span><span class="na">cacheResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">))</span>
<span class="lineno">32</span>         <span class="o">.</span><span class="na">networkResponse</span><span class="o">(</span><span class="n">stripBody</span><span class="o">(</span><span class="n">networkResponse</span><span class="o">))</span>
<span class="lineno">33</span>         <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">34</span> 
<span class="lineno">35</span>     <span class="k">if</span> <span class="o">(</span><span class="n">hasBody</span><span class="o">(</span><span class="n">userResponse</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">36</span>       <span class="n">maybeCache</span><span class="o">();</span>
<span class="lineno">37</span>       <span class="n">userResponse</span> <span class="o">=</span> <span class="n">unzip</span><span class="o">(</span><span class="n">cacheWritingResponse</span><span class="o">(</span><span class="n">storeRequest</span><span class="o">,</span> <span class="n">userResponse</span><span class="o">));</span>
<span class="lineno">38</span>     <span class="o">}</span>
<span class="lineno">39</span>   <span class="o">}</span></code></pre></div>

<p>大致说一下，就是把priorResponse、cacheResponse以及我们刚才从server中拿到的networkResponse和起来放入userResponse里面(最后一行会构建一个新的response，换一个source，并解压，其实并没有看懂，因为Okio这块还是有知识点缺失)，如果要cache的话也不要忘了加入到缓存中去</p>

<p>至此，readResponse就结束了，不过response的内容我们还没有拿到，继续看getResponse里面：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>       <span class="c1">// blahblahblah</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>       <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">getResponse</span><span class="o">();</span>
<span class="lineno"> 6</span>       <span class="n">Request</span> <span class="n">followUp</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">followUpRequest</span><span class="o">();</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>       <span class="k">if</span> <span class="o">(</span><span class="n">followUp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">forWebSocket</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>           <span class="n">engine</span><span class="o">.</span><span class="na">releaseStreamAllocation</span><span class="o">();</span>
<span class="lineno">11</span>         <span class="o">}</span>
<span class="lineno">12</span>         <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="lineno">13</span>       <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>       <span class="n">StreamAllocation</span> <span class="n">streamAllocation</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>       <span class="k">if</span> <span class="o">(++</span><span class="n">followUpCount</span> <span class="o">&gt;</span> <span class="n">MAX_FOLLOW_UPS</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">18</span>         <span class="n">streamAllocation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="lineno">19</span>         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ProtocolException</span><span class="o">(</span><span class="s">&quot;Too many follow-up requests: &quot;</span> <span class="o">+</span> <span class="n">followUpCount</span><span class="o">);</span>
<span class="lineno">20</span>       <span class="o">}</span>
<span class="lineno">21</span> 
<span class="lineno">22</span>       <span class="k">if</span> <span class="o">(!</span><span class="n">engine</span><span class="o">.</span><span class="na">sameConnection</span><span class="o">(</span><span class="n">followUp</span><span class="o">.</span><span class="na">url</span><span class="o">()))</span> <span class="o">{</span>
<span class="lineno">23</span>         <span class="n">streamAllocation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="lineno">24</span>         <span class="n">streamAllocation</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">25</span>       <span class="o">}</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>       <span class="n">request</span> <span class="o">=</span> <span class="n">followUp</span><span class="o">;</span>
<span class="lineno">28</span>       <span class="n">engine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpEngine</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">forWebSocket</span><span class="o">,</span> <span class="n">streamAllocation</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
<span class="lineno">29</span>           <span class="n">response</span><span class="o">);</span>
<span class="lineno">30</span>     <span class="o">}</span></code></pre></div>

<p>engine.getResponse只是把userResponse拿出来，关键是要看有没有followUpRequest：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Figures out the HTTP request to make in response to receiving this engine&#39;s response. This will</span>
<span class="lineno"> 3</span> <span class="cm">   * either add authentication headers, follow redirects or handle a client request timeout. If a</span>
<span class="lineno"> 4</span> <span class="cm">   * follow-up is either unnecessary or not applicable, this returns null.</span>
<span class="lineno"> 5</span> <span class="cm">   */</span>
<span class="lineno"> 6</span>   <span class="kd">public</span> <span class="n">Request</span> <span class="nf">followUpRequest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 7</span>     <span class="k">if</span> <span class="o">(</span><span class="n">userResponse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">();</span>
<span class="lineno"> 8</span>     <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">streamAllocation</span><span class="o">.</span><span class="na">connection</span><span class="o">();</span>
<span class="lineno"> 9</span>     <span class="n">Route</span> <span class="n">route</span> <span class="o">=</span> <span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span>
<span class="lineno">10</span>         <span class="o">?</span> <span class="n">connection</span><span class="o">.</span><span class="na">route</span><span class="o">()</span>
<span class="lineno">11</span>         <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">12</span>     <span class="kt">int</span> <span class="n">responseCode</span> <span class="o">=</span> <span class="n">userResponse</span><span class="o">.</span><span class="na">code</span><span class="o">();</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>     <span class="kd">final</span> <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">method</span><span class="o">();</span>
<span class="lineno">15</span>     <span class="k">switch</span> <span class="o">(</span><span class="n">responseCode</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">16</span>       <span class="k">case</span> <span class="nl">HTTP_PROXY_AUTH:</span>
<span class="lineno">17</span>         <span class="n">Proxy</span> <span class="n">selectedProxy</span> <span class="o">=</span> <span class="n">route</span> <span class="o">!=</span> <span class="kc">null</span>
<span class="lineno">18</span>             <span class="o">?</span> <span class="n">route</span><span class="o">.</span><span class="na">proxy</span><span class="o">()</span>
<span class="lineno">19</span>             <span class="o">:</span> <span class="n">client</span><span class="o">.</span><span class="na">proxy</span><span class="o">();</span>
<span class="lineno">20</span>         <span class="k">if</span> <span class="o">(</span><span class="n">selectedProxy</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">HTTP</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">21</span>           <span class="k">throw</span> <span class="k">new</span> <span class="nf">ProtocolException</span><span class="o">(</span><span class="s">&quot;Received HTTP_PROXY_AUTH (407) code while not using proxy&quot;</span><span class="o">);</span>
<span class="lineno">22</span>         <span class="o">}</span>
<span class="lineno">23</span>         <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">proxyAuthenticator</span><span class="o">().</span><span class="na">authenticate</span><span class="o">(</span><span class="n">route</span><span class="o">,</span> <span class="n">userResponse</span><span class="o">);</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>       <span class="k">case</span> <span class="nl">HTTP_UNAUTHORIZED:</span>
<span class="lineno">26</span>         <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">authenticator</span><span class="o">().</span><span class="na">authenticate</span><span class="o">(</span><span class="n">route</span><span class="o">,</span> <span class="n">userResponse</span><span class="o">);</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>       <span class="k">case</span> <span class="nl">HTTP_PERM_REDIRECT:</span>
<span class="lineno">29</span>       <span class="k">case</span> <span class="nl">HTTP_TEMP_REDIRECT:</span>
<span class="lineno">30</span>         <span class="c1">// &quot;If the 307 or 308 status code is received in response to a request other than GET</span>
<span class="lineno">31</span>         <span class="c1">// or HEAD, the user agent MUST NOT automatically redirect the request&quot;</span>
<span class="lineno">32</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">method</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">method</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;HEAD&quot;</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">33</span>           <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">34</span>         <span class="o">}</span>
<span class="lineno">35</span>         <span class="c1">// fall-through</span>
<span class="lineno">36</span>       <span class="k">case</span> <span class="nl">HTTP_MULT_CHOICE:</span>
<span class="lineno">37</span>       <span class="k">case</span> <span class="nl">HTTP_MOVED_PERM:</span>
<span class="lineno">38</span>       <span class="k">case</span> <span class="nl">HTTP_MOVED_TEMP:</span>
<span class="lineno">39</span>       <span class="k">case</span> <span class="nl">HTTP_SEE_OTHER:</span>
<span class="lineno">40</span>         <span class="c1">// Does the client allow redirects?</span>
<span class="lineno">41</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">client</span><span class="o">.</span><span class="na">followRedirects</span><span class="o">())</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">42</span> 
<span class="lineno">43</span>         <span class="n">String</span> <span class="n">location</span> <span class="o">=</span> <span class="n">userResponse</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Location&quot;</span><span class="o">);</span>
<span class="lineno">44</span>         <span class="k">if</span> <span class="o">(</span><span class="n">location</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">45</span>         <span class="n">HttpUrl</span> <span class="n">url</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
<span class="lineno">46</span> 
<span class="lineno">47</span>         <span class="c1">// Don&#39;t follow redirects to unsupported protocols.</span>
<span class="lineno">48</span>         <span class="k">if</span> <span class="o">(</span><span class="n">url</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">49</span> 
<span class="lineno">50</span>         <span class="c1">// If configured, don&#39;t follow redirects between SSL and non-SSL.</span>
<span class="lineno">51</span>         <span class="kt">boolean</span> <span class="n">sameScheme</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">scheme</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">userRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">scheme</span><span class="o">());</span>
<span class="lineno">52</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">sameScheme</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">client</span><span class="o">.</span><span class="na">followSslRedirects</span><span class="o">())</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">53</span> 
<span class="lineno">54</span>         <span class="c1">// Redirects don&#39;t include a request body.</span>
<span class="lineno">55</span>         <span class="n">Request</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span> <span class="o">=</span> <span class="n">userRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
<span class="lineno">56</span>         <span class="k">if</span> <span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">permitsRequestBody</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">57</span>           <span class="k">if</span> <span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">redirectsToGet</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">58</span>             <span class="n">requestBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="lineno">59</span>           <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">60</span>             <span class="n">requestBuilder</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="lineno">61</span>           <span class="o">}</span>
<span class="lineno">62</span>           <span class="n">requestBuilder</span><span class="o">.</span><span class="na">removeHeader</span><span class="o">(</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="o">);</span>
<span class="lineno">63</span>           <span class="n">requestBuilder</span><span class="o">.</span><span class="na">removeHeader</span><span class="o">(</span><span class="s">&quot;Content-Length&quot;</span><span class="o">);</span>
<span class="lineno">64</span>           <span class="n">requestBuilder</span><span class="o">.</span><span class="na">removeHeader</span><span class="o">(</span><span class="s">&quot;Content-Type&quot;</span><span class="o">);</span>
<span class="lineno">65</span>         <span class="o">}</span>
<span class="lineno">66</span> 
<span class="lineno">67</span>         <span class="c1">// When redirecting across hosts, drop all authentication headers. This</span>
<span class="lineno">68</span>         <span class="c1">// is potentially annoying to the application layer since they have no</span>
<span class="lineno">69</span>         <span class="c1">// way to retain them.</span>
<span class="lineno">70</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">sameConnection</span><span class="o">(</span><span class="n">url</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">71</span>           <span class="n">requestBuilder</span><span class="o">.</span><span class="na">removeHeader</span><span class="o">(</span><span class="s">&quot;Authorization&quot;</span><span class="o">);</span>
<span class="lineno">72</span>         <span class="o">}</span>
<span class="lineno">73</span> 
<span class="lineno">74</span>         <span class="k">return</span> <span class="n">requestBuilder</span><span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">75</span> 
<span class="lineno">76</span>       <span class="k">case</span> <span class="nl">HTTP_CLIENT_TIMEOUT:</span>
<span class="lineno">77</span>         <span class="c1">// 408&#39;s are rare in practice, but some servers like HAProxy use this response code. The</span>
<span class="lineno">78</span>         <span class="c1">// spec says that we may repeat the request without modifications. Modern browsers also</span>
<span class="lineno">79</span>         <span class="c1">// repeat the request (even non-idempotent ones.)</span>
<span class="lineno">80</span>         <span class="kt">boolean</span> <span class="n">retryableBody</span> <span class="o">=</span> <span class="n">requestBodyOut</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">requestBodyOut</span> <span class="k">instanceof</span> <span class="n">RetryableSink</span><span class="o">;</span>
<span class="lineno">81</span>         <span class="k">if</span> <span class="o">(</span><span class="n">callerWritesRequestBody</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retryableBody</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">82</span>           <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">83</span>         <span class="o">}</span>
<span class="lineno">84</span> 
<span class="lineno">85</span>         <span class="k">return</span> <span class="n">userRequest</span><span class="o">;</span>
<span class="lineno">86</span> 
<span class="lineno">87</span>       <span class="k">default</span><span class="o">:</span>
<span class="lineno">88</span>         <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">89</span>     <span class="o">}</span>
<span class="lineno">90</span>   <span class="o">}</span></code></pre></div>

<p>就不一条一条分析了，大致就是根据userResponse的responseCode来判断是否需要再发起一次request，如果需要的话就再构建一个</p>

<p>我们回到getResponse，如果没有followUp Request，就将stream和connection断开，释放engine的StreamAllocation，返回response
如果还有，那仅仅是将engine.close，在这之中只会将一些io端口关掉，并返回原来的streamAllocation，因为它是要保留进行下一次操作的，不过如果followUp的connection和当前request的url不一样，也就是属于不同的connection，那还是会释放这个streamAllocation，最后，再重新new一个engine，进行下一个循环的操作</p>

<p>好了，getResponse可以返回了，最终这个response会返回到AsycCall的getResponseWithInterceptorChain，然后调用responseCallback.onResponse(RealCall.this, response)，这样就的到了最终的结果～ 当然了，还在client的dispatcher中把这个call给finish，不知道还记得起来这个dispatcher不～</p>

<p>最后我们来看看response.string()做了什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">   * Returns the response as a string decoded with the charset of the Content-Type header. If that</span>
<span class="lineno"> 3</span> <span class="cm">   * header is either absent or lacks a charset, this will attempt to decode the response body as</span>
<span class="lineno"> 4</span> <span class="cm">   * UTF-8.</span>
<span class="lineno"> 5</span> <span class="cm">   */</span>
<span class="lineno"> 6</span>   <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">string</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno"> 7</span>     <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">(),</span> <span class="n">charset</span><span class="o">().</span><span class="na">name</span><span class="o">());</span>
<span class="lineno"> 8</span>   <span class="o">}</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> 
<span class="lineno">11</span>   <span class="kd">public</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">bytes</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="lineno">12</span>     <span class="kt">long</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentLength</span><span class="o">();</span>
<span class="lineno">13</span>     <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">&gt;</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Cannot buffer entire body for content length: &quot;</span> <span class="o">+</span> <span class="n">contentLength</span><span class="o">);</span>
<span class="lineno">15</span>     <span class="o">}</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="n">BufferedSource</span> <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">();</span>
<span class="lineno">18</span>     <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">;</span>
<span class="lineno">19</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno">20</span>       <span class="n">bytes</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">readByteArray</span><span class="o">();</span>
<span class="lineno">21</span>     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="lineno">22</span>       <span class="n">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
<span class="lineno">23</span>     <span class="o">}</span>
<span class="lineno">24</span>     <span class="k">if</span> <span class="o">(</span><span class="n">contentLength</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">contentLength</span> <span class="o">!=</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">25</span>       <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Content-Length and stream length disagree&quot;</span><span class="o">);</span>
<span class="lineno">26</span>     <span class="o">}</span>
<span class="lineno">27</span>     <span class="k">return</span> <span class="n">bytes</span><span class="o">;</span>
<span class="lineno">28</span>   <span class="o">}</span></code></pre></div>

<p>最后一块石头落地，这些数据确实是从source里read出来的</p>

<h2 id="section"><em>总结</em></h2>

<p>整个okhttp其实是一个非常庞大的项目，我也只是追踪了冰山一角中的一条线的代码，但已经感受良多，分为一下几个方面：</p>

<ul>
  <li>
    <p>整个项目充斥着builder、单例、策略等设计模式，还有很多我可能认不出的，虽然给代码跟踪带来了一些小小的障碍，但是极大的降低了组建之间的耦合程度，这么大的一个project，不同的人写不同的模块，设计模式确实可以帮助更高效的开发和测试</p>
  </li>
  <li>
    <p>对于并行处理事件上又多了一点感悟，光依赖线程池是不够的，要灵活的控制task还要再开一个队列，由它来控制task的cancel与否，或者统计哪些在执行的哪些是不在执行的，并且要等这个task执行结束后再从这个队列里销毁，能够及时知道它的状态，对这个task有更好的掌控性，事实上Volley也是这么做的，但是也要注意处理多线程数据同步问题(AsyncTask现在变成串行的了，因此没有这个问题)</p>
  </li>
  <li>
    <p>okhttp的interceptor拦截器给我的印象很深，我认为这是一种AOP编程思想，在这里画一个流程图会比较好的解释：</p>
  </li>
</ul>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>   <span class="o">&lt;---------------------------------------------------</span>
<span class="lineno"> 2</span>       <span class="n">nextChain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chain</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>                                         <span class="o">|</span>
<span class="lineno"> 3</span>       <span class="n">interceptor</span> <span class="o">=</span> <span class="n">getNextInterceptor</span><span class="o">()</span>                                     <span class="o">|</span>
<span class="lineno"> 4</span>       <span class="k">if</span> <span class="o">(</span><span class="n">interceptor</span><span class="o">)</span>                                                       <span class="o">|</span>
<span class="lineno"> 5</span>           <span class="k">return</span> <span class="n">interceptor</span><span class="o">.</span><span class="na">intercept</span><span class="o">(</span><span class="n">chain</span><span class="o">)</span>                                <span class="o">|</span>
<span class="lineno"> 6</span>       <span class="k">else</span>                               <span class="o">|</span>                                   <span class="o">|</span> 
<span class="lineno"> 7</span>           <span class="k">return</span> <span class="n">defalut</span>                 <span class="n">v</span>                                   <span class="o">|</span>
<span class="lineno"> 8</span>                                        <span class="k">do</span> <span class="n">sth</span><span class="o">.</span> <span class="n">before</span>                        <span class="o">|</span>   
<span class="lineno"> 9</span>                                        <span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">chain</span><span class="o">.</span><span class="na">request</span><span class="o">)-----</span>
<span class="lineno">10</span>                                        <span class="k">do</span> <span class="n">sth</span><span class="o">.</span> <span class="n">after</span>
<span class="lineno">11</span>                                        <span class="k">return</span> <span class="n">res</span></code></pre></div>

<ul>
  <li>
    <p>会维护一个ConnectionPool，争取最大限度的复用connection这种socket物理连接，这跟Android里handler的msg以及inBitmap有相似的道理。同时用一个stream来维护一个逻辑上的request/response的pair，有种多路复用的感觉，这个优化应该是以后自己的项目中能够想的到的一种优化(假设多个事务同时操作文件，那个可以把对同一个文件的操作分为逻辑操作和物理操作两种，逻辑操作可以复用物理上的buffer而不用重新销毁再创建)</p>
  </li>
  <li>
    <p>对于cache的设计，okhttp不像universal-image-loader那样单独的设计两级缓存，我在代码中看到了snapshot之类的字眼，以后有空一定会专门去分析它来看看如何设计一个健壮高效的cache</p>
  </li>
  <li>
    <p>现在能体会到优秀开源代码的厉害之处了，以后一定要多多看看这种代码，长长见识才能更好的提高自己</p>
  </li>
</ul>


  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">
	<div class="info">
      		<ul>
			<li>转载请注明出处<a class="this-link" href="http://moonfacex.github.io/blog/java/2016/04/06/okhttp.html">http://moonfacex.github.io/blog/java/2016/04/06/okhttp.html</a></li>
        		<li>如有疑问，可以微博私信我或者发邮件给我</li>
      		</ul>
    	</div>
    
    <div class="footer-col-1 column">
      <ul>
        <li>MoonfaceX</li>
        <li><a href="mailto:mr.moonfacex@gmail.com">mr.moonfacex@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/MoonfaceX/moonface.github.io">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
	  <a href="http://weibo.com/u/1005421853"
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">You'll never walk alone.</p>
    </div>

  </div>

</footer>


    </body>
</html>