<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>EventBus 原理解析</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="You'll never walk alone.">
    <link rel="canonical" href="http://moonfacex.github.io/blog/android/2016/04/08/eventbus.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="http://moonfacex.github.io/blog/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="http://moonfacex.github.io/blog">Moonspace</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="http://moonfacex.github.io/blog/about/">About</a>
        
          <a class="page-link" href="http://moonfacex.github.io/blog/feed.xml"></a>
        
          <a class="page-link" href="http://moonfacex.github.io/blog/index.html"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>EventBus 原理解析</h1>
    <p class="meta">Apr 8, 2016</p>
  </header>

  <article class="post-content">
  <p>我们都知道，在Android中默认只有一个UI线程，并且还不是线程安全的，当我们要做一些耗时的操作时，就有必要另开一个线程来做这些事以此来避免ANR。不过这其中会遇到一个问题，在异步线程中做完一个task，要把信息反馈给UI线程才能去操作view。<br />
一般我们是怎么做的呢？handler，传递一个UI线程的handler给这个task，完成后用这个handler去sendMessage也好post也好，那就可以到主线程里去处理了。不过handler的劣势也很明显：</p>

<ol>
  <li>
    <p>message中的Data只能通过bundle传递，这就也就是必须是可序列化的数据，这有一定的限制，而且效率上也会打折扣</p>
  </li>
  <li>
    <p>handler生命周期跟主线程的Looper是一样的，比Activity、Service等系统组建的生命周期要长的多，不注意使用就会造成activity等内存泄漏，即使是使用static来声明这个handler，那也会长期占用内存直到UI线程退出，如果每个activity都要使用handler，那看起来确实不那么优雅</p>
  </li>
  <li>
    <p>如果是两个非UI线程之间的交互，那接受线程就必须创建自己的Loop，或者直接使用HandlerThread</p>
  </li>
</ol>

<p>有没有稍微便捷一点的方法呢？<a href="http://greenrobot.org/eventbus/">EventBus</a>就给我们提供了这么一种工具,这个项目在github上收获了大量的star，那我们本着学习的心态，看看人家是怎么处理这样的case的</p>

<p>还是要简单的从如何使用开始讲起：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestEvent</span> <span class="o">{</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="kd">public</span> <span class="nf">TestEvent</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>         <span class="k">this</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="o">}</span>
<span class="lineno"> 8</span> <span class="o">}</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>  	<span class="nd">@Override</span>
<span class="lineno">13</span> 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span> 	    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
<span class="lineno">15</span> 	    <span class="n">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="lineno">16</span> 	<span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>  	<span class="nd">@Override</span>
<span class="lineno">19</span> 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">20</span> 	    <span class="n">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">unregister</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="lineno">21</span> 	    <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
<span class="lineno">22</span> 	<span class="o">}</span>
<span class="lineno">23</span> 
<span class="lineno">24</span> 	<span class="nd">@Subscribe</span><span class="o">(</span><span class="n">threadMode</span> <span class="o">=</span> <span class="n">ThreadMode</span><span class="o">.</span><span class="na">MAIN</span><span class="o">)</span>
<span class="lineno">25</span> 	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEventMainThread</span><span class="o">(</span><span class="n">TestEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">26</span> 	    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">msg</span><span class="o">)</span>    
<span class="lineno">27</span> 	<span class="o">}</span>
<span class="lineno">28</span> <span class="o">}</span>
<span class="lineno">29</span> 
<span class="lineno">30</span> <span class="c1">// somewhere in another thread</span>
<span class="lineno">31</span> 
<span class="lineno">32</span> <span class="n">EventBus</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">TestEvent</span><span class="o">(</span><span class="s">&quot;this is a test&quot;</span><span class="o">));</span></code></pre></div>

<p>用法很简单，先自定义一个Event，然后在你要接收这个类型event的activity里用注解写一个onEvent，在别的线程中post一个此类型的event，就可以在activity中收到这个event了，当然不能忘记在activity的onCreate/onDestory里进行register/unregister操作</p>

<p>最大的疑惑可能就是注解里的threadMode了，先来解释一下，一共有四种mode：	
-	POSTING：在哪个线程中post就在哪个线程中调用onEvent，没有线程的切换</p>

<ul>
  <li>
    <p>MAIN：onEvent一定会在UI线程中调用</p>
  </li>
  <li>
    <p>BACKGROUND：如果post thread不是UI线程，那就直接在这个线程里调用onEvent，如果在UI线程里post，那就会在后台开一个线程，一个接着一个的调用onEventBackground</p>
  </li>
  <li>
    <p>ASYNC：onEvent的调用会独立于post线程和主线程，也就是会另开一个线程池并发、异步的处理这些event</p>
  </li>
</ul>

<p>那我们就从register开始说起吧</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * Registers the given subscriber to receive events. Subscribers must call {@link #unregister(Object)} once they</span>
<span class="lineno"> 3</span> <span class="cm">     * are no longer interested in receiving events.</span>
<span class="lineno"> 4</span> <span class="cm">     * &lt;p/&gt;</span>
<span class="lineno"> 5</span> <span class="cm">     * Subscribers have event handling methods that must be annotated by {@link Subscribe}.</span>
<span class="lineno"> 6</span> <span class="cm">     * The {@link Subscribe} annotation also allows configuration like {@link</span>
<span class="lineno"> 7</span> <span class="cm">     * ThreadMode} and priority.</span>
<span class="lineno"> 8</span> <span class="cm">     */</span>
<span class="lineno"> 9</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">Object</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="lineno">11</span>         <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">subscriberMethodFinder</span><span class="o">.</span><span class="na">findSubscriberMethods</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
<span class="lineno">12</span>         <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">13</span>             <span class="k">for</span> <span class="o">(</span><span class="n">SubscriberMethod</span> <span class="n">subscriberMethod</span> <span class="o">:</span> <span class="n">subscriberMethods</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>                 <span class="n">subscribe</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">);</span>
<span class="lineno">15</span>             <span class="o">}</span>
<span class="lineno">16</span>         <span class="o">}</span>
<span class="lineno">17</span>     <span class="o">}</span></code></pre></div>

<ul>
  <li>
    <p>首先获得subscriber的class</p>
  </li>
  <li>
    <p>根据这个class找到一个订阅方法列表</p>
  </li>
  <li>
    <p>然后将这些订阅方法和subscriber一起订阅起来</p>
  </li>
</ul>

<p>一头雾水，那就看看findSubscriberMethods做了什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;&gt;</span> <span class="n">METHOD_CACHE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>     <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;</span> <span class="nf">findSubscriberMethods</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 4</span>         <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">METHOD_CACHE</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
<span class="lineno"> 5</span>         <span class="k">if</span> <span class="o">(</span><span class="n">subscriberMethods</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>             <span class="k">return</span> <span class="n">subscriberMethods</span><span class="o">;</span>
<span class="lineno"> 7</span>         <span class="o">}</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>         <span class="k">if</span> <span class="o">(</span><span class="n">ignoreGeneratedIndex</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">10</span>             <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">findUsingReflection</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
<span class="lineno">11</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">12</span>             <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">findUsingInfo</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
<span class="lineno">13</span>         <span class="o">}</span>
<span class="lineno">14</span>         <span class="k">if</span> <span class="o">(</span><span class="n">subscriberMethods</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">15</span>             <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">&quot;Subscriber &quot;</span> <span class="o">+</span> <span class="n">subscriberClass</span>
<span class="lineno">16</span>                     <span class="o">+</span> <span class="s">&quot; and its super classes have no public methods with the @Subscribe annotation&quot;</span><span class="o">);</span>
<span class="lineno">17</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">18</span>             <span class="n">METHOD_CACHE</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">,</span> <span class="n">subscriberMethods</span><span class="o">);</span>
<span class="lineno">19</span>             <span class="k">return</span> <span class="n">subscriberMethods</span><span class="o">;</span>
<span class="lineno">20</span>         <span class="o">}</span>
<span class="lineno">21</span>     <span class="o">}</span></code></pre></div>

<p>这里通过ConcurrentHashMap建立了一个小缓存，先去这里面找，找不到了，我们先看看是如何通过反射的方式来操作的：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;</span> <span class="nf">findUsingReflection</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">FindState</span> <span class="n">findState</span> <span class="o">=</span> <span class="n">prepareFindState</span><span class="o">();</span>
<span class="lineno"> 3</span>     <span class="n">findState</span><span class="o">.</span><span class="na">initForSubscriber</span><span class="o">(</span><span class="n">subscriberClass</span><span class="o">);</span>
<span class="lineno"> 4</span>     <span class="k">while</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span>         <span class="n">findUsingReflectionInSingleClass</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
<span class="lineno"> 6</span>         <span class="n">findState</span><span class="o">.</span><span class="na">moveToSuperclass</span><span class="o">();</span>
<span class="lineno"> 7</span>     <span class="o">}</span>
<span class="lineno"> 8</span>     <span class="k">return</span> <span class="nf">getMethodsAndRelease</span><span class="o">(</span><span class="n">findState</span><span class="o">);</span>
<span class="lineno"> 9</span> <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="kd">private</span> <span class="n">FindState</span> <span class="nf">prepareFindState</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">12</span>     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">FIND_STATE_POOL</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">13</span>         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">POOL_SIZE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="lineno">14</span>             <span class="n">FindState</span> <span class="n">state</span> <span class="o">=</span> <span class="n">FIND_STATE_POOL</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
<span class="lineno">15</span>             <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">16</span>                 <span class="n">FIND_STATE_POOL</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">17</span>                 <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
<span class="lineno">18</span>             <span class="o">}</span>
<span class="lineno">19</span>         <span class="o">}</span>
<span class="lineno">20</span>     <span class="o">}</span>
<span class="lineno">21</span>     <span class="k">return</span> <span class="k">new</span> <span class="nf">FindState</span><span class="o">();</span>
<span class="lineno">22</span> <span class="o">}</span></code></pre></div>

<p>首先prepareFindState里面，只是从一个FIND_STATE_POOL数组里拿出一个findstate，那还得看看FindState是什么：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FindState</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="lineno"> 3</span>     <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">anyMethodByEventType</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="lineno"> 4</span>     <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Class</span><span class="o">&gt;</span> <span class="n">subscriberClassByMethodKey</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="lineno"> 5</span>     <span class="kd">final</span> <span class="n">StringBuilder</span> <span class="n">methodKeyBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">;</span>
<span class="lineno"> 8</span>     <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">;</span>
<span class="lineno"> 9</span>     <span class="kt">boolean</span> <span class="n">skipSuperClasses</span><span class="o">;</span>
<span class="lineno">10</span>     <span class="n">SubscriberInfo</span> <span class="n">subscriberInfo</span><span class="o">;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>     <span class="kt">void</span> <span class="nf">initForSubscriber</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">subscriberClass</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">13</span>         <span class="k">this</span><span class="o">.</span><span class="na">subscriberClass</span> <span class="o">=</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">subscriberClass</span><span class="o">;</span>
<span class="lineno">14</span>         <span class="n">skipSuperClasses</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">15</span>         <span class="n">subscriberInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">16</span>     <span class="o">}</span></code></pre></div>

<p>只看到了一大托的List、Map，貌似要是存放一些什么东西，init好像也只是设置了clazz
还是来看看到底反射能帮我们做些什么吧：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">findUsingReflectionInSingleClass</span><span class="o">(</span><span class="n">FindState</span> <span class="n">findState</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span><span class="o">;</span>
<span class="lineno"> 3</span>     <span class="k">try</span> <span class="o">{</span>
<span class="lineno"> 4</span>         <span class="c1">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span>
<span class="lineno"> 5</span>         <span class="n">methods</span> <span class="o">=</span> <span class="n">findState</span><span class="o">.</span><span class="na">clazz</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
<span class="lineno"> 6</span>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>         <span class="c1">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span>
<span class="lineno"> 8</span>         <span class="n">methods</span> <span class="o">=</span> <span class="n">findState</span><span class="o">.</span><span class="na">clazz</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
<span class="lineno"> 9</span>         <span class="n">findState</span><span class="o">.</span><span class="na">skipSuperClasses</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">10</span>     <span class="o">}</span>
<span class="lineno">11</span>     <span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
<span class="lineno">13</span>         <span class="k">if</span> <span class="o">((</span><span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">MODIFIERS_IGNORE</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>             <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
<span class="lineno">15</span>             <span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">16</span>                 <span class="n">Subscribe</span> <span class="n">subscribeAnnotation</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Subscribe</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">17</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">subscribeAnnotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">18</span>                     <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="lineno">19</span>                     <span class="k">if</span> <span class="o">(</span><span class="n">findState</span><span class="o">.</span><span class="na">checkAdd</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">20</span>                         <span class="n">ThreadMode</span> <span class="n">threadMode</span> <span class="o">=</span> <span class="n">subscribeAnnotation</span><span class="o">.</span><span class="na">threadMode</span><span class="o">();</span>
<span class="lineno">21</span>                         <span class="n">findState</span><span class="o">.</span><span class="na">subscriberMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SubscriberMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">eventType</span><span class="o">,</span> <span class="n">threadMode</span><span class="o">,</span>
<span class="lineno">22</span>                                 <span class="n">subscribeAnnotation</span><span class="o">.</span><span class="na">priority</span><span class="o">(),</span> <span class="n">subscribeAnnotation</span><span class="o">.</span><span class="na">sticky</span><span class="o">()));</span>
<span class="lineno">23</span>                     <span class="o">}</span>
<span class="lineno">24</span>                 <span class="o">}</span>
<span class="lineno">25</span>             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strictMethodVerification</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">Subscribe</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">26</span>                 <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
<span class="lineno">27</span>                 <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">&quot;@Subscribe method &quot;</span> <span class="o">+</span> <span class="n">methodName</span> <span class="o">+</span>
<span class="lineno">28</span>                         <span class="s">&quot;must have exactly 1 parameter but has &quot;</span> <span class="o">+</span> <span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
<span class="lineno">29</span>             <span class="o">}</span>
<span class="lineno">30</span>         <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strictMethodVerification</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">Subscribe</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">31</span>             <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
<span class="lineno">32</span>             <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="n">methodName</span> <span class="o">+</span>
<span class="lineno">33</span>                     <span class="s">&quot; is a illegal @Subscribe method: must be public, non-static, and non-abstract&quot;</span><span class="o">);</span>
<span class="lineno">34</span>         <span class="o">}</span>
<span class="lineno">35</span>     <span class="o">}</span>
<span class="lineno">36</span> <span class="o">}</span></code></pre></div>

<ul>
  <li>
    <p>先通过反射，找到这个class(也就是我们的Activity)的所有method，遍历它们</p>
  </li>
  <li>
    <p>13行确定这个method仅仅是public，才能继续处理</p>
  </li>
  <li>
    <p>14、15行说，这个method必须只有一个类型的参数才可以！</p>
  </li>
  <li>
    <p>接下来看这个method有没有声明Subscribe注解，没有的话不要！</p>
  </li>
  <li>
    <p>19行将这个method和event参数的class类型(例子中就是TestEvent.class)交给findState.checkAdd,看看它做了什么：</p>
  </li>
</ul>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kt">boolean</span> <span class="nf">checkAdd</span><span class="o">(</span><span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="c1">// 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required.</span>
<span class="lineno"> 3</span>     <span class="c1">// Usually a subscriber doesn&#39;t have methods listening to the same event type.</span>
<span class="lineno"> 4</span>     <span class="n">Object</span> <span class="n">existing</span> <span class="o">=</span> <span class="n">anyMethodByEventType</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
<span class="lineno"> 5</span>     <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 6</span>         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="k">if</span> <span class="o">(</span><span class="n">existing</span> <span class="k">instanceof</span> <span class="n">Method</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>             <span class="k">if</span> <span class="o">(!</span><span class="n">checkAddWithMethodSignature</span><span class="o">((</span><span class="n">Method</span><span class="o">)</span> <span class="n">existing</span><span class="o">,</span> <span class="n">eventType</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">10</span>                 <span class="c1">// Paranoia check</span>
<span class="lineno">11</span>                 <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
<span class="lineno">12</span>             <span class="o">}</span>
<span class="lineno">13</span>             <span class="c1">// Put any non-Method object to &quot;consume&quot; the existing Method</span>
<span class="lineno">14</span>             <span class="n">anyMethodByEventType</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="lineno">15</span>         <span class="o">}</span>
<span class="lineno">16</span>         <span class="k">return</span> <span class="nf">checkAddWithMethodSignature</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">eventType</span><span class="o">);</span>
<span class="lineno">17</span>     <span class="o">}</span>
<span class="lineno">18</span> <span class="o">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkAddWithMethodSignature</span><span class="o">(</span><span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">21</span>     <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="lineno">22</span>     <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="lineno">23</span>     <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;&gt;&#39;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="lineno">24</span> 
<span class="lineno">25</span>     <span class="n">String</span> <span class="n">methodKey</span> <span class="o">=</span> <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="lineno">26</span>     <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">methodClass</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">();</span>
<span class="lineno">27</span>     <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">methodClassOld</span> <span class="o">=</span> <span class="n">subscriberClassByMethodKey</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">methodClass</span><span class="o">);</span>
<span class="lineno">28</span>     <span class="k">if</span> <span class="o">(</span><span class="n">methodClassOld</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">methodClassOld</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">methodClass</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">29</span>         <span class="c1">// Only add if not already found in a sub class</span>
<span class="lineno">30</span>         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">31</span>     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">32</span>         <span class="c1">// Revert the put, old class is further down the class hierarchy</span>
<span class="lineno">33</span>         <span class="n">subscriberClassByMethodKey</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">methodClassOld</span><span class="o">);</span>
<span class="lineno">34</span>         <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">35</span>     <span class="o">}</span>
<span class="lineno">36</span> <span class="o">}</span></code></pre></div>

<p>先看checkAddWithMethodSignature：</p>

<pre><code>首先把method的name和eventType的name拼接成字符串key
找到method的class，看看subscriberClassByMethodKey中有没有key和class的pair
如果有，就替换为原来的的class，返回false
如果没有或者原来class是method的class的父类(也就是子类把父类替换掉)则返回true
</code></pre>

<p>再看checkAdd</p>

<ol>
  <li>
    <p>检查是否之前已经存过对应的eventType与method的pair，如过没存过，返回true，add成功</p>
  </li>
  <li>
    <p>如果之前存过，并且以前的那个也是一个Method，则进入checkAddWithMethodSignature，如果签名不匹配，则会抛出异常，反之会设置一个无关紧要的object，这样下次检查的时候就不用这么费事了</p>
  </li>
  <li>
    <p>最后再检查一下当前method和evenType的签名是否正确</p>
  </li>
</ol>

<p>回到findUsingReflectionInSingleClass</p>

<ul>
  <li>21行new一个SubscriberMethod，也就是保存一些信息，放入subscriberMethods的一个List中就结束了</li>
</ul>

<p>回到findUsingReflection，不断的去找当前clazz的父类，直到系统类，最后会释放这个findState，把它还给FIND_STATE_POOL</p>

<p>这样，我们就得到了一个SubscriberMethod的列表，每一个SubscriberMethod里面都维护了method、threadMode、eventType、priority、sticky参数
回到register里，有了这个列表，我们就可以对每一个SubscriberMethod调用subscribe了：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="c1">// Must be called in synchronized block</span>
<span class="lineno"> 2</span>     <span class="kd">private</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="n">Object</span> <span class="n">subscriber</span><span class="o">,</span> <span class="n">SubscriberMethod</span> <span class="n">subscriberMethod</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>         <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">eventType</span><span class="o">;</span>
<span class="lineno"> 4</span>         <span class="n">Subscription</span> <span class="n">newSubscription</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subscription</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">);</span>
<span class="lineno"> 5</span>         <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">Subscription</span><span class="o">&gt;</span> <span class="n">subscriptions</span> <span class="o">=</span> <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
<span class="lineno"> 6</span>         <span class="k">if</span> <span class="o">(</span><span class="n">subscriptions</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>             <span class="n">subscriptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
<span class="lineno"> 8</span>             <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">eventType</span><span class="o">,</span> <span class="n">subscriptions</span><span class="o">);</span>
<span class="lineno"> 9</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">10</span>             <span class="k">if</span> <span class="o">(</span><span class="n">subscriptions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">11</span>                 <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">&quot;Subscriber &quot;</span> <span class="o">+</span> <span class="n">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; already registered to event &quot;</span>
<span class="lineno">12</span>                         <span class="o">+</span> <span class="n">eventType</span><span class="o">);</span>
<span class="lineno">13</span>             <span class="o">}</span>
<span class="lineno">14</span>         <span class="o">}</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>         <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="lineno">17</span>         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="lineno">18</span>             <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">size</span> <span class="o">||</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">priority</span> <span class="o">&gt;</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">priority</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>                 <span class="n">subscriptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">newSubscription</span><span class="o">);</span>
<span class="lineno">20</span>                 <span class="k">break</span><span class="o">;</span>
<span class="lineno">21</span>             <span class="o">}</span>
<span class="lineno">22</span>         <span class="o">}</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>         <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">subscribedEvents</span> <span class="o">=</span> <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span>
<span class="lineno">25</span>         <span class="k">if</span> <span class="o">(</span><span class="n">subscribedEvents</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">26</span>             <span class="n">subscribedEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="lineno">27</span>             <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscribedEvents</span><span class="o">);</span>
<span class="lineno">28</span>         <span class="o">}</span>
<span class="lineno">29</span>         <span class="n">subscribedEvents</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>         <span class="k">if</span> <span class="o">(</span><span class="n">subscriberMethod</span><span class="o">.</span><span class="na">sticky</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">32</span>             <span class="k">if</span> <span class="o">(</span><span class="n">eventInheritance</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">33</span>                 <span class="c1">// Existing sticky events of all subclasses of eventType have to be considered.</span>
<span class="lineno">34</span>                 <span class="c1">// Note: Iterating over all events may be inefficient with lots of sticky events,</span>
<span class="lineno">35</span>                 <span class="c1">// thus data structure should be changed to allow a more efficient lookup</span>
<span class="lineno">36</span>                 <span class="c1">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span>
<span class="lineno">37</span>                 <span class="n">Set</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">stickyEvents</span><span class="o">.</span><span class="na">entrySet</span><span class="o">();</span>
<span class="lineno">38</span>                 <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entries</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">39</span>                     <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateEventType</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
<span class="lineno">40</span>                     <span class="k">if</span> <span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">candidateEventType</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">41</span>                         <span class="n">Object</span> <span class="n">stickyEvent</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
<span class="lineno">42</span>                         <span class="n">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">);</span>
<span class="lineno">43</span>                     <span class="o">}</span>
<span class="lineno">44</span>                 <span class="o">}</span>
<span class="lineno">45</span>             <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">46</span>                 <span class="n">Object</span> <span class="n">stickyEvent</span> <span class="o">=</span> <span class="n">stickyEvents</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
<span class="lineno">47</span>                 <span class="n">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">);</span>
<span class="lineno">48</span>             <span class="o">}</span>
<span class="lineno">49</span>         <span class="o">}</span>
<span class="lineno">50</span>     <span class="o">}</span></code></pre></div>

<ul>
  <li>
    <p>首先获取eventType类型，并把这个对象和subscriberMethod拼成一个Subscription，注意到没有，我们有了对象，有了方法，以后就可以通过反射去调用这个方法了！</p>
  </li>
  <li>
    <p>通过这个eventType从hashMap里获得一个Subscription的列表，把新建的Subscription加进去</p>
  </li>
  <li>
    <p>再把这个eventType加到这个subscriber所订阅的eventType集合里去</p>
  </li>
  <li>
    <p>最后会保存一些sticky的event，保证它们是可以被被动查询到的</p>
  </li>
</ul>

<p>就这样结束了，所有的Subscription都保存在subscriptionsByEventType里，通过eventType进行分类，然后对应的value是一个列表，存放订阅这个eventType的所有对象以及方法和threadMode</p>

<p>接下来看看post：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/** Posts the given event to the event bus. */</span>
<span class="lineno"> 2</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">post</span><span class="o">(</span><span class="n">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="n">PostingThreadState</span> <span class="n">postingState</span> <span class="o">=</span> <span class="n">currentPostingThreadState</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="lineno"> 4</span>     <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">eventQueue</span> <span class="o">=</span> <span class="n">postingState</span><span class="o">.</span><span class="na">eventQueue</span><span class="o">;</span>
<span class="lineno"> 5</span>     <span class="n">eventQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="k">if</span> <span class="o">(!</span><span class="n">postingState</span><span class="o">.</span><span class="na">isPosting</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="n">postingState</span><span class="o">.</span><span class="na">isMainThread</span> <span class="o">=</span> <span class="n">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">()</span> <span class="o">==</span> <span class="n">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
<span class="lineno"> 9</span>         <span class="n">postingState</span><span class="o">.</span><span class="na">isPosting</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">10</span>         <span class="k">if</span> <span class="o">(</span><span class="n">postingState</span><span class="o">.</span><span class="na">canceled</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">11</span>             <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">&quot;Internal error. Abort state was not reset&quot;</span><span class="o">);</span>
<span class="lineno">12</span>         <span class="o">}</span>
<span class="lineno">13</span>         <span class="k">try</span> <span class="o">{</span>
<span class="lineno">14</span>             <span class="k">while</span> <span class="o">(!</span><span class="n">eventQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">15</span>                 <span class="n">postSingleEvent</span><span class="o">(</span><span class="n">eventQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">postingState</span><span class="o">);</span>
<span class="lineno">16</span>             <span class="o">}</span>
<span class="lineno">17</span>         <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="lineno">18</span>             <span class="n">postingState</span><span class="o">.</span><span class="na">isPosting</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">19</span>             <span class="n">postingState</span><span class="o">.</span><span class="na">isMainThread</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">20</span>         <span class="o">}</span>
<span class="lineno">21</span>     <span class="o">}</span>
<span class="lineno">22</span> <span class="o">}</span></code></pre></div>

<p>在这其中会将这个event加入一个队列，如果队列还没有开始post，则会最终调用postSingleEventForEventType：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">postSingleEventForEventType</span><span class="o">(</span><span class="n">Object</span> <span class="n">event</span><span class="o">,</span> <span class="n">PostingThreadState</span> <span class="n">postingState</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventClass</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>         <span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">Subscription</span><span class="o">&gt;</span> <span class="n">subscriptions</span><span class="o">;</span>
<span class="lineno"> 3</span>         <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 4</span>             <span class="n">subscriptions</span> <span class="o">=</span> <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventClass</span><span class="o">);</span>
<span class="lineno"> 5</span>         <span class="o">}</span>
<span class="lineno"> 6</span>         <span class="k">if</span> <span class="o">(</span><span class="n">subscriptions</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">subscriptions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno"> 7</span>             <span class="k">for</span> <span class="o">(</span><span class="n">Subscription</span> <span class="n">subscription</span> <span class="o">:</span> <span class="n">subscriptions</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>                 <span class="n">postingState</span><span class="o">.</span><span class="na">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">;</span>
<span class="lineno"> 9</span>                 <span class="n">postingState</span><span class="o">.</span><span class="na">subscription</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">;</span>
<span class="lineno">10</span>                 <span class="kt">boolean</span> <span class="n">aborted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">11</span>                 <span class="k">try</span> <span class="o">{</span>
<span class="lineno">12</span>                     <span class="n">postToSubscription</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">postingState</span><span class="o">.</span><span class="na">isMainThread</span><span class="o">);</span>
<span class="lineno">13</span>                     <span class="n">aborted</span> <span class="o">=</span> <span class="n">postingState</span><span class="o">.</span><span class="na">canceled</span><span class="o">;</span>
<span class="lineno">14</span>                 <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="lineno">15</span>                     <span class="n">postingState</span><span class="o">.</span><span class="na">event</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">16</span>                     <span class="n">postingState</span><span class="o">.</span><span class="na">subscription</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">17</span>                     <span class="n">postingState</span><span class="o">.</span><span class="na">canceled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">18</span>                 <span class="o">}</span>
<span class="lineno">19</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">aborted</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">20</span>                     <span class="k">break</span><span class="o">;</span>
<span class="lineno">21</span>                 <span class="o">}</span>
<span class="lineno">22</span>             <span class="o">}</span>
<span class="lineno">23</span>             <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">24</span>         <span class="o">}</span>
<span class="lineno">25</span>         <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">26</span>     <span class="o">}</span></code></pre></div>

<p>它会根据event的类型，从subscriptionsByEventType里找到之前提过的subscription队列，然后一个一个执行postToSubscription：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">postToSubscription</span><span class="o">(</span><span class="n">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="n">Object</span> <span class="n">event</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>         <span class="k">switch</span> <span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">threadMode</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>             <span class="k">case</span> <span class="nl">POSTING:</span>
<span class="lineno"> 4</span>                 <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno"> 5</span>                 <span class="k">break</span><span class="o">;</span>
<span class="lineno"> 6</span>             <span class="k">case</span> <span class="nl">MAIN:</span>
<span class="lineno"> 7</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>                     <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno"> 9</span>                 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">10</span>                     <span class="n">mainThreadPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno">11</span>                 <span class="o">}</span>
<span class="lineno">12</span>                 <span class="k">break</span><span class="o">;</span>
<span class="lineno">13</span>             <span class="k">case</span> <span class="nl">BACKGROUND:</span>
<span class="lineno">14</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>                     <span class="n">backgroundPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno">16</span>                 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">17</span>                     <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno">18</span>                 <span class="o">}</span>
<span class="lineno">19</span>                 <span class="k">break</span><span class="o">;</span>
<span class="lineno">20</span>             <span class="k">case</span> <span class="nl">ASYNC:</span>
<span class="lineno">21</span>                 <span class="n">asyncPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno">22</span>                 <span class="k">break</span><span class="o">;</span>
<span class="lineno">23</span>             <span class="k">default</span><span class="o">:</span>
<span class="lineno">24</span>                 <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Unknown thread mode: &quot;</span> <span class="o">+</span> <span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">threadMode</span><span class="o">);</span>
<span class="lineno">25</span>         <span class="o">}</span>
<span class="lineno">26</span>     <span class="o">}</span></code></pre></div>

<p>如果是POSTING，或者MAIN模式下已经在UI线程了又或者是在BACKGROUND模式但不在UI线程，直接反射调用：</p>

<div class="highlight"><pre><code class="java"><span class="lineno">1</span> <span class="kt">void</span> <span class="nf">invokeSubscriber</span><span class="o">(</span><span class="n">Subscription</span> <span class="n">subscription</span><span class="o">,</span> <span class="n">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">2</span>         <span class="k">try</span> <span class="o">{</span>
<span class="lineno">3</span>             <span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="lineno">4</span>         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">5</span>             <span class="n">handleSubscriberException</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
<span class="lineno">6</span>         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">7</span>             <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Unexpected exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="lineno">8</span>         <span class="o">}</span>
<span class="lineno">9</span>     <span class="o">}</span></code></pre></div>

<ul>
  <li>
    <p>如果是MAIN模式，会通过mainThreadPoster，本质是一个handler，把这个subscription加入它的一个等待队列中，然后发送msg，在handleMessage里从队列里取出这个subscription反射执行</p>
  </li>
  <li>
    <p>如果是BACKGROUND模式，会投递到backgroundPoster里，也加入一个队列，通过eventBus内部的线程池执行一个runnable，这个runnable循环从这个队列里取出subscription并执行，但是要注意的是，这个backgroundPoster有一个private volatile boolean executorRunning变量，保证串行的执行这些subscription</p>
  </li>
  <li>
    <p>如果是ASYNC模式，投递到asyncPoster，也有是eventBus的内部线程池执行的，它是可以并行的</p>
  </li>
</ul>

<h2 id="section"><em>总结</em></h2>

<ul>
  <li>
    <p>利用反射的方法来实现事件总线，觉得很巧妙，感慨反射的强大，虽然反射是运行时进行的，由于不能预加载class以及jit优化，效率肯定是比不上已经编译好的字节码的，但这种动态语言的思想还是很重要的</p>
  </li>
  <li>
    <p>这次又看到了XXX_POOL,这种什么什么池的概念在大规模处理数据的时候还是很有用的，减少了gc和重新new的开销</p>
  </li>
  <li>
    <p>还有一些细节并没有追踪完整，但我觉得目前要做的还是理解它大致框架和思想是第一位的，代码这种东西都是熟能生巧的</p>
  </li>
</ul>


  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">
	<div class="info">
      		<ul>
			<li>转载请注明出处<a class="this-link" href="http://moonfacex.github.io/blog/android/2016/04/08/eventbus.html">http://moonfacex.github.io/blog/android/2016/04/08/eventbus.html</a></li>
        		<li>如有疑问，可以微博私信我或者发邮件给我</li>
      		</ul>
    	</div>
    
    <div class="footer-col-1 column">
      <ul>
        <li>MoonfaceX</li>
        <li><a href="mailto:mr.moonfacex@gmail.com">mr.moonfacex@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/MoonfaceX/moonface.github.io">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
	  <a href="http://weibo.com/u/1005421853"
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">You'll never walk alone.</p>
    </div>

  </div>

</footer>


    </body>
</html>