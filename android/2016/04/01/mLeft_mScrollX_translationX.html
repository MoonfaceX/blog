<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>mLeft mScrollX translationX 傻傻分不清楚</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="You'll never walk alone.">
    <link rel="canonical" href="http://moonfacex.github.io/moonface.github.io/android/2016/04/01/mLeft_mScrollX_translationX.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="http://moonfacex.github.io/moonface.github.io/css/main.css">

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="http://moonfacex.github.io/moonface.github.io">Moonface Space</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="http://moonfacex.github.io/moonface.github.io/about/">About</a>
        
          <a class="page-link" href="http://moonfacex.github.io/moonface.github.io/feed.xml"></a>
        
          <a class="page-link" href="http://moonfacex.github.io/moonface.github.io/index.html"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>mLeft mScrollX translationX 傻傻分不清楚</h1>
    <p class="meta">Apr 1, 2016</p>
  </header>

  <article class="post-content">
  <p>一开始看到这个标题内心是血崩的 ^ ^</p>

<p>先抛出几个锅：view的getLeft返回什么？ getScrollX返回什么？ getX返回什么？ getTranslationX返回什么？</p>

<p>onLayout大家都知道吧</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * Called from layout when this view should</span>
<span class="lineno"> 3</span> <span class="cm">     * assign a size and position to each of its children.</span>
<span class="lineno"> 4</span> <span class="cm">     *</span>
<span class="lineno"> 5</span> <span class="cm">     * Derived classes with children should override</span>
<span class="lineno"> 6</span> <span class="cm">     * this method and call layout on each of</span>
<span class="lineno"> 7</span> <span class="cm">     * their children.</span>
<span class="lineno"> 8</span> <span class="cm">     * @param changed This is a new size or position for this view</span>
<span class="lineno"> 9</span> <span class="cm">     * @param left Left position, relative to parent</span>
<span class="lineno">10</span> <span class="cm">     * @param top Top position, relative to parent</span>
<span class="lineno">11</span> <span class="cm">     * @param right Right position, relative to parent</span>
<span class="lineno">12</span> <span class="cm">     * @param bottom Bottom position, relative to parent</span>
<span class="lineno">13</span> <span class="cm">     */</span>
<span class="lineno">14</span>     <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onLayout</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">changed</span><span class="o">,</span> <span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">top</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bottom</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>     <span class="o">}</span></code></pre></div>

<p>说了这个参数left (top right bottom) 是相对于父view的左间距， 那么这个left哪里来呢？ 自然就要去看看layout：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">layout</span><span class="o">(</span><span class="kt">int</span> <span class="n">l</span><span class="o">,</span> <span class="kt">int</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">r</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>         <span class="c1">// blahblah...</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>         <span class="kt">boolean</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">isLayoutModeOptical</span><span class="o">(</span><span class="n">mParent</span><span class="o">)</span> <span class="o">?</span>
<span class="lineno"> 5</span>                 <span class="n">setOpticalFrame</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">:</span> <span class="n">setFrame</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>         <span class="k">if</span> <span class="o">(</span><span class="n">changed</span> <span class="o">||</span> <span class="o">(</span><span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="n">PFLAG_LAYOUT_REQUIRED</span><span class="o">)</span> <span class="o">==</span> <span class="n">PFLAG_LAYOUT_REQUIRED</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>             <span class="n">onLayout</span><span class="o">(</span><span class="n">changed</span><span class="o">,</span> <span class="n">l</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
<span class="lineno"> 9</span>             <span class="c1">// blahblah...</span>
<span class="lineno">10</span>     <span class="o">}</span></code></pre></div>

<p>其中setOpticalFrame最终也会调用setFrame：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">setFrame</span><span class="o">(</span><span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">top</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bottom</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>         <span class="c1">// blahblah...</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>         <span class="k">if</span> <span class="o">(</span><span class="n">mLeft</span> <span class="o">!=</span> <span class="n">left</span> <span class="o">||</span> <span class="n">mRight</span> <span class="o">!=</span> <span class="n">right</span> <span class="o">||</span> <span class="n">mTop</span> <span class="o">!=</span> <span class="n">top</span> <span class="o">||</span> <span class="n">mBottom</span> <span class="o">!=</span> <span class="n">bottom</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span>             <span class="n">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>             <span class="c1">// Remember our drawn bit</span>
<span class="lineno"> 8</span>             <span class="kt">int</span> <span class="n">drawn</span> <span class="o">=</span> <span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="n">PFLAG_DRAWN</span><span class="o">;</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>             <span class="kt">int</span> <span class="n">oldWidth</span> <span class="o">=</span> <span class="n">mRight</span> <span class="o">-</span> <span class="n">mLeft</span><span class="o">;</span>
<span class="lineno">11</span>             <span class="kt">int</span> <span class="n">oldHeight</span> <span class="o">=</span> <span class="n">mBottom</span> <span class="o">-</span> <span class="n">mTop</span><span class="o">;</span>
<span class="lineno">12</span>             <span class="kt">int</span> <span class="n">newWidth</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="o">;</span>
<span class="lineno">13</span>             <span class="kt">int</span> <span class="n">newHeight</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span><span class="o">;</span>
<span class="lineno">14</span>             <span class="kt">boolean</span> <span class="n">sizeChanged</span> <span class="o">=</span> <span class="o">(</span><span class="n">newWidth</span> <span class="o">!=</span> <span class="n">oldWidth</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">newHeight</span> <span class="o">!=</span> <span class="n">oldHeight</span><span class="o">);</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>             <span class="c1">// Invalidate our old position</span>
<span class="lineno">17</span>             <span class="n">invalidate</span><span class="o">(</span><span class="n">sizeChanged</span><span class="o">);</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>             <span class="n">mLeft</span> <span class="o">=</span> <span class="n">left</span><span class="o">;</span>
<span class="lineno">20</span>             <span class="n">mTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">;</span>
<span class="lineno">21</span>             <span class="n">mRight</span> <span class="o">=</span> <span class="n">right</span><span class="o">;</span>
<span class="lineno">22</span>             <span class="n">mBottom</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">;</span>
<span class="lineno">23</span>             <span class="n">mRenderNode</span><span class="o">.</span><span class="na">setLeftTopRightBottom</span><span class="o">(</span><span class="n">mLeft</span><span class="o">,</span> <span class="n">mTop</span><span class="o">,</span> <span class="n">mRight</span><span class="o">,</span> <span class="n">mBottom</span><span class="o">);</span>
<span class="lineno">24</span>         	
<span class="lineno">25</span>         	<span class="c1">// blahblah...</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>     <span class="o">}</span></code></pre></div>

<p>看到没有，将这个left传给了mLeft， 那mLeft是什么？</p>

<div class="highlight"><pre><code class="java"><span class="lineno">1</span> <span class="cm">/**</span>
<span class="lineno">2</span> <span class="cm">     * Left position of this view relative to its parent.</span>
<span class="lineno">3</span> <span class="cm">     *</span>
<span class="lineno">4</span> <span class="cm">     * @return The left edge of this view, in pixels.</span>
<span class="lineno">5</span> <span class="cm">     */</span>
<span class="lineno">6</span>     <span class="nd">@ViewDebug.CapturedViewProperty</span>
<span class="lineno">7</span>     <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getLeft</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">8</span>         <span class="k">return</span> <span class="n">mLeft</span><span class="o">;</span>
<span class="lineno">9</span>     <span class="o">}</span></code></pre></div>

<font color="red">getLeft返回的是本view与父view左边界的间距, 也就是layout过程中确定的父子view的相对位置， 也就是显示布局边界看到的边界</font>
<p>也就是说你不重新在layout过程中改变想对于parent的位置，那么mLeft是不会变的</p>

<hr />

<p>Scroller大家都用过吧， 用来控制滑动的， 简单给个sample好了：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">smoothScrollBy</span><span class="o">(</span><span class="kt">int</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="o">)</span> <span class="o">{</span>  
<span class="lineno"> 2</span>         <span class="n">mScroller</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">mScroller</span><span class="o">.</span><span class="na">getFinalX</span><span class="o">(),</span> <span class="n">mScroller</span><span class="o">.</span><span class="na">getFinalY</span><span class="o">(),</span> <span class="n">dx</span><span class="o">,</span> <span class="n">dy</span><span class="o">);</span>  
<span class="lineno"> 3</span>         <span class="n">invalidate</span><span class="o">();</span>
<span class="lineno"> 4</span>     <span class="o">}</span>  
<span class="lineno"> 5</span>       
<span class="lineno"> 6</span>     <span class="nd">@Override</span>  
<span class="lineno"> 7</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">computeScroll</span><span class="o">()</span> <span class="o">{</span>  
<span class="lineno"> 8</span>       
<span class="lineno"> 9</span>         <span class="k">if</span> <span class="o">(</span><span class="n">mScroller</span><span class="o">.</span><span class="na">computeScrollOffset</span><span class="o">())</span> <span class="o">{</span>  
<span class="lineno">10</span>           
<span class="lineno">11</span>             <span class="n">scrollTo</span><span class="o">(</span><span class="n">mScroller</span><span class="o">.</span><span class="na">getCurrX</span><span class="o">(),</span> <span class="n">mScroller</span><span class="o">.</span><span class="na">getCurrY</span><span class="o">());</span>  
<span class="lineno">12</span>               
<span class="lineno">13</span>             <span class="n">postInvalidate</span><span class="o">();</span>  
<span class="lineno">14</span>         <span class="o">}</span>  
<span class="lineno">15</span>         <span class="kd">super</span><span class="o">.</span><span class="na">computeScroll</span><span class="o">();</span>  
<span class="lineno">16</span>     <span class="o">}</span></code></pre></div>

<p>基本上Scroller就是一个计时器， 根据走过的时间，计算出当前滑的坐标，然后调用scrollTo才是真正让view显示出滑动的效果， scrollTo本身没有动画效果， 所以本质上scroller就是一个润滑油， 使invalidate更加缓和，从而达到滑的视觉效果</p>

<font color="green">首先要明确一点，手机屏幕的坐标，默认x向右增长，因此我们做动画的时候，增加translationX什么的都会往右移动， 但是当你增加mScrollX时，内容是向左移，为什么等下说</font>

<p>那么scrollTo跟mScrollX是什么关系呢？到底滑的是什么？</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scrollTo</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 2</span>         <span class="k">if</span> <span class="o">(</span><span class="n">mScrollX</span> <span class="o">!=</span> <span class="n">x</span> <span class="o">||</span> <span class="n">mScrollY</span> <span class="o">!=</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>             <span class="kt">int</span> <span class="n">oldX</span> <span class="o">=</span> <span class="n">mScrollX</span><span class="o">;</span>
<span class="lineno"> 4</span>             <span class="kt">int</span> <span class="n">oldY</span> <span class="o">=</span> <span class="n">mScrollY</span><span class="o">;</span>
<span class="lineno"> 5</span>             <span class="n">mScrollX</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
<span class="lineno"> 6</span>             <span class="n">mScrollY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
<span class="lineno"> 7</span>             <span class="n">invalidateParentCaches</span><span class="o">();</span>
<span class="lineno"> 8</span>             <span class="n">onScrollChanged</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="n">oldX</span><span class="o">,</span> <span class="n">oldY</span><span class="o">);</span>
<span class="lineno"> 9</span>             <span class="k">if</span> <span class="o">(!</span><span class="n">awakenScrollBars</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">10</span>                 <span class="n">postInvalidateOnAnimation</span><span class="o">();</span>
<span class="lineno">11</span>             <span class="o">}</span>
<span class="lineno">12</span>         <span class="o">}</span>
<span class="lineno">13</span>     <span class="o">}</span></code></pre></div>

<p>很简单嘛，只不过就是将x设置给了mScrollX，然后调用postInvalidateOnAnimation(这个方法会把本view加入viewRootImpl的一个缓存中，然后在适当的时候viewRootImpl会调用这个缓存中所有view的invalidate， 这又会引起viewRootImpl的scheduleTraversals引起重绘， 关于invalidate和requestLayout以后有空再详细分析好了)<br />
那么这样，每scrollTo一次就可以draw一次啦， 那再去看看draw(我们看ViewGroup.drawChild()调用的draw会看的更清楚一点， 原因等会儿说)到底干了什么让view滑了起来：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * This method is called by ViewGroup.drawChild() to have each child view draw itself.</span>
<span class="lineno"> 3</span> <span class="cm">     *</span>
<span class="lineno"> 4</span> <span class="cm">     * This is where the View specializes rendering behavior based on layer type,</span>
<span class="lineno"> 5</span> <span class="cm">     * and hardware acceleration.</span>
<span class="lineno"> 6</span> <span class="cm">     */</span>
<span class="lineno"> 7</span>     <span class="kt">boolean</span> <span class="nf">draw</span><span class="o">(</span><span class="n">Canvas</span> <span class="n">canvas</span><span class="o">,</span> <span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">long</span> <span class="n">drawingTime</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="c1">// blahblah... </span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>         <span class="kt">int</span> <span class="n">sx</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno">11</span>         <span class="kt">int</span> <span class="n">sy</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno">12</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">drawingWithRenderNode</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">13</span>             <span class="n">computeScroll</span><span class="o">();</span>
<span class="lineno">14</span>             <span class="n">sx</span> <span class="o">=</span> <span class="n">mScrollX</span><span class="o">;</span>
<span class="lineno">15</span>             <span class="n">sy</span> <span class="o">=</span> <span class="n">mScrollY</span><span class="o">;</span>
<span class="lineno">16</span>         <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>         <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">drawingWithDrawingCache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">drawingWithRenderNode</span><span class="o">;</span>
<span class="lineno">19</span>         <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">offsetForScroll</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">drawingWithRenderNode</span><span class="o">;</span>
<span class="lineno">20</span> 		
<span class="lineno">21</span> 		<span class="c1">// blahblah...</span>
<span class="lineno">22</span>         
<span class="lineno">23</span>         <span class="k">if</span> <span class="o">(</span><span class="n">offsetForScroll</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">24</span>             <span class="n">canvas</span><span class="o">.</span><span class="na">translate</span><span class="o">(</span><span class="n">mLeft</span> <span class="o">-</span> <span class="n">sx</span><span class="o">,</span> <span class="n">mTop</span> <span class="o">-</span> <span class="n">sy</span><span class="o">);</span>
<span class="lineno">25</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">26</span>             <span class="k">if</span> <span class="o">(!</span><span class="n">drawingWithRenderNode</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">27</span>                 <span class="n">canvas</span><span class="o">.</span><span class="na">translate</span><span class="o">(</span><span class="n">mLeft</span><span class="o">,</span> <span class="n">mTop</span><span class="o">);</span>
<span class="lineno">28</span>             <span class="o">}</span>
<span class="lineno">29</span> 
<span class="lineno">30</span>         <span class="c1">// blahblah...</span>
<span class="lineno">31</span> 
<span class="lineno">32</span>         <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">drawingWithRenderNode</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">getAlpha</span><span class="o">()</span> <span class="o">*</span> <span class="n">getTransitionAlpha</span><span class="o">());</span>
<span class="lineno">33</span>         <span class="k">if</span> <span class="o">(</span><span class="n">transformToApply</span> <span class="o">!=</span> <span class="kc">null</span>
<span class="lineno">34</span>                 <span class="o">||</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="lineno">35</span>                 <span class="o">||</span> <span class="o">!</span><span class="n">hasIdentityMatrix</span><span class="o">()</span>
<span class="lineno">36</span>                 <span class="o">||</span> <span class="o">(</span><span class="n">mPrivateFlags3</span> <span class="o">&amp;</span> <span class="n">PFLAG3_VIEW_IS_ANIMATING_ALPHA</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">37</span>             <span class="k">if</span> <span class="o">(</span><span class="n">transformToApply</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">childHasIdentityMatrix</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">38</span>                 <span class="kt">int</span> <span class="n">transX</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno">39</span>                 <span class="kt">int</span> <span class="n">transY</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno">40</span> 
<span class="lineno">41</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">offsetForScroll</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">42</span>                     <span class="n">transX</span> <span class="o">=</span> <span class="o">-</span><span class="n">sx</span><span class="o">;</span>
<span class="lineno">43</span>                     <span class="n">transY</span> <span class="o">=</span> <span class="o">-</span><span class="n">sy</span><span class="o">;</span>
<span class="lineno">44</span>                 <span class="o">}</span>
<span class="lineno">45</span> 
<span class="lineno">46</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">transformToApply</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">47</span>                     <span class="k">if</span> <span class="o">(</span><span class="n">concatMatrix</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">48</span>                         <span class="k">if</span> <span class="o">(</span><span class="n">drawingWithRenderNode</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">49</span>                             <span class="n">renderNode</span><span class="o">.</span><span class="na">setAnimationMatrix</span><span class="o">(</span><span class="n">transformToApply</span><span class="o">.</span><span class="na">getMatrix</span><span class="o">());</span>
<span class="lineno">50</span>                         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">51</span>                             <span class="c1">// Undo the scroll translation, apply the transformation matrix,</span>
<span class="lineno">52</span>                             <span class="c1">// then redo the scroll translate to get the correct result.</span>
<span class="lineno">53</span>                             <span class="n">canvas</span><span class="o">.</span><span class="na">translate</span><span class="o">(-</span><span class="n">transX</span><span class="o">,</span> <span class="o">-</span><span class="n">transY</span><span class="o">);</span>
<span class="lineno">54</span>                             <span class="n">canvas</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">transformToApply</span><span class="o">.</span><span class="na">getMatrix</span><span class="o">());</span>
<span class="lineno">55</span>                             <span class="n">canvas</span><span class="o">.</span><span class="na">translate</span><span class="o">(</span><span class="n">transX</span><span class="o">,</span> <span class="n">transY</span><span class="o">);</span>
<span class="lineno">56</span>                         <span class="o">}</span>
<span class="lineno">57</span>                         
<span class="lineno">58</span>         <span class="c1">// blahblah...</span>
<span class="lineno">59</span> 
<span class="lineno">60</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">drawingWithDrawingCache</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">61</span>             <span class="k">if</span> <span class="o">(</span><span class="n">drawingWithRenderNode</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">62</span>                 <span class="n">mPrivateFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PFLAG_DIRTY_MASK</span><span class="o">;</span>
<span class="lineno">63</span>                 <span class="o">((</span><span class="n">DisplayListCanvas</span><span class="o">)</span> <span class="n">canvas</span><span class="o">).</span><span class="na">drawRenderNode</span><span class="o">(</span><span class="n">renderNode</span><span class="o">);</span>
<span class="lineno">64</span>             <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">65</span>                 <span class="c1">// Fast path for layouts with no backgrounds</span>
<span class="lineno">66</span>                 <span class="k">if</span> <span class="o">((</span><span class="n">mPrivateFlags</span> <span class="o">&amp;</span> <span class="n">PFLAG_SKIP_DRAW</span><span class="o">)</span> <span class="o">==</span> <span class="n">PFLAG_SKIP_DRAW</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">67</span>                     <span class="n">mPrivateFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PFLAG_DIRTY_MASK</span><span class="o">;</span>
<span class="lineno">68</span>                     <span class="n">dispatchDraw</span><span class="o">(</span><span class="n">canvas</span><span class="o">);</span>
<span class="lineno">69</span>                 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">70</span>                     <span class="n">draw</span><span class="o">(</span><span class="n">canvas</span><span class="o">);</span>
<span class="lineno">71</span>                 <span class="o">}</span>
<span class="lineno">72</span>             <span class="o">}</span>
<span class="lineno">73</span>         <span class="o">}</span> 
<span class="lineno">74</span> 
<span class="lineno">75</span>         <span class="c1">// blahblah...</span>
<span class="lineno">76</span>     <span class="o">}</span></code></pre></div>

<p>draw的代码非常长，里面的逻辑也很复杂，说实话我看不懂，但是我们可以从第24、51行发现一些蛛丝马迹：</p>

<p>24.将整个画布平移， mLeft刚才解释了，再减去负的mScrollX，对，负的！自己画一下吧，这就是真正的偏移量！</p>

<p>51.人家注释都说了，undo 和 redo scroll translation是通过canvas平移来实现变换的，而平移的量就是12行拿到的mScrollX !</p>

<p>至此，我有了一个大胆的猜想：<font color="red">scroll的操作是通过移动view的canvas来实现的，跟layout没有任何关系，由于子view的内容全部画在parent的canvas上，当parent的canvas整体平移时， 子view也会跟着移动，并且不需要重绘</font><br />
要论证上述猜想， 我们换个思路，看看TouchEvent是怎么分发的吧：</p>

<p>我们知道，在一个view收到一个TouchEvent的时候，却getX是得到这个event在本view中的偏移，那么可想而知从parent分发这个event的时候，必定要对x进行操作，以保证子view中能等到正确的偏移：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="nd">@Override</span>
<span class="lineno"> 2</span>     <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">dispatchTouchEvent</span><span class="o">(</span><span class="n">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 3</span>         <span class="c1">// blahblah...</span>
<span class="lineno"> 4</span>         <span class="k">if</span> <span class="o">(</span><span class="n">newTouchTarget</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">childrenCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 5</span>             <span class="kd">final</span> <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">(</span><span class="n">actionIndex</span><span class="o">);</span>
<span class="lineno"> 6</span>                         <span class="kd">final</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">(</span><span class="n">actionIndex</span><span class="o">);</span>
<span class="lineno"> 7</span>                         <span class="c1">// Find a child that can receive the event.</span>
<span class="lineno"> 8</span>                         <span class="c1">// Scan children from front to back.</span>
<span class="lineno"> 9</span>                         <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;</span> <span class="n">preorderedList</span> <span class="o">=</span> <span class="n">buildOrderedChildList</span><span class="o">();</span>
<span class="lineno">10</span>                         <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">customOrder</span> <span class="o">=</span> <span class="n">preorderedList</span> <span class="o">==</span> <span class="kc">null</span>
<span class="lineno">11</span>                                 <span class="o">&amp;&amp;</span> <span class="n">isChildrenDrawingOrderEnabled</span><span class="o">();</span>
<span class="lineno">12</span>                         <span class="kd">final</span> <span class="n">View</span><span class="o">[]</span> <span class="n">children</span> <span class="o">=</span> <span class="n">mChildren</span><span class="o">;</span>
<span class="lineno">13</span>                         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">childrenCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
<span class="lineno">14</span>                             <span class="kd">final</span> <span class="kt">int</span> <span class="n">childIndex</span> <span class="o">=</span> <span class="n">customOrder</span>
<span class="lineno">15</span>                                     <span class="o">?</span> <span class="n">getChildDrawingOrder</span><span class="o">(</span><span class="n">childrenCount</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">:</span> <span class="n">i</span><span class="o">;</span>
<span class="lineno">16</span>                             <span class="kd">final</span> <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="o">(</span><span class="n">preorderedList</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
<span class="lineno">17</span>                                     <span class="o">?</span> <span class="n">children</span><span class="o">[</span><span class="n">childIndex</span><span class="o">]</span> <span class="o">:</span> <span class="n">preorderedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">childIndex</span><span class="o">);</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>                             <span class="c1">// If there is a view that has accessibility focus we want it</span>
<span class="lineno">20</span>                             <span class="c1">// to get the event first and if not handled we will perform a</span>
<span class="lineno">21</span>                             <span class="c1">// normal dispatch. We may do a double iteration but this is</span>
<span class="lineno">22</span>                             <span class="c1">// safer given the timeframe.</span>
<span class="lineno">23</span>                             <span class="k">if</span> <span class="o">(</span><span class="n">childWithAccessibilityFocus</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">24</span>                                 <span class="k">if</span> <span class="o">(</span><span class="n">childWithAccessibilityFocus</span> <span class="o">!=</span> <span class="n">child</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">25</span>                                     <span class="k">continue</span><span class="o">;</span>
<span class="lineno">26</span>                                 <span class="o">}</span>
<span class="lineno">27</span>                                 <span class="n">childWithAccessibilityFocus</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">28</span>                                 <span class="n">i</span> <span class="o">=</span> <span class="n">childrenCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
<span class="lineno">29</span>                             <span class="o">}</span>
<span class="lineno">30</span> 
<span class="lineno">31</span>                             <span class="k">if</span> <span class="o">(!</span><span class="n">canViewReceivePointerEvents</span><span class="o">(</span><span class="n">child</span><span class="o">)</span>
<span class="lineno">32</span>                                     <span class="o">||</span> <span class="o">!</span><span class="n">isTransformedTouchPointInView</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">child</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">33</span>                                 <span class="n">ev</span><span class="o">.</span><span class="na">setTargetAccessibilityFocus</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="lineno">34</span>                                 <span class="k">continue</span><span class="o">;</span>
<span class="lineno">35</span>                             <span class="o">}</span>
<span class="lineno">36</span> 
<span class="lineno">37</span>                             <span class="c1">// blahblah...</span>
<span class="lineno">38</span> 
<span class="lineno">39</span>             <span class="c1">// Dispatch to touch targets.</span>
<span class="lineno">40</span>             <span class="k">if</span> <span class="o">(</span><span class="n">mFirstTouchTarget</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">41</span>                 <span class="c1">// No touch targets so treat this as an ordinary view.</span>
<span class="lineno">42</span>                 <span class="n">handled</span> <span class="o">=</span> <span class="n">dispatchTransformedTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="n">canceled</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
<span class="lineno">43</span>                         <span class="n">TouchTarget</span><span class="o">.</span><span class="na">ALL_POINTER_IDS</span><span class="o">);</span>
<span class="lineno">44</span>             <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">45</span>                 <span class="c1">// Dispatch to touch targets, excluding the new touch target if we already</span>
<span class="lineno">46</span>                 <span class="c1">// dispatched to it.  Cancel touch targets if necessary.</span>
<span class="lineno">47</span>                 <span class="n">TouchTarget</span> <span class="n">predecessor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="lineno">48</span>                 <span class="n">TouchTarget</span> <span class="n">target</span> <span class="o">=</span> <span class="n">mFirstTouchTarget</span><span class="o">;</span>
<span class="lineno">49</span>                 <span class="k">while</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">50</span>                     <span class="kd">final</span> <span class="n">TouchTarget</span> <span class="n">next</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
<span class="lineno">51</span>                     <span class="k">if</span> <span class="o">(</span><span class="n">alreadyDispatchedToNewTouchTarget</span> <span class="o">&amp;&amp;</span> <span class="n">target</span> <span class="o">==</span> <span class="n">newTouchTarget</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">52</span>                         <span class="n">handled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">53</span>                     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">54</span>                         <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">cancelChild</span> <span class="o">=</span> <span class="n">resetCancelNextUpFlag</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">child</span><span class="o">)</span>
<span class="lineno">55</span>                                 <span class="o">||</span> <span class="n">intercepted</span><span class="o">;</span>
<span class="lineno">56</span>                         <span class="k">if</span> <span class="o">(</span><span class="n">dispatchTransformedTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="n">cancelChild</span><span class="o">,</span>
<span class="lineno">57</span>                                 <span class="n">target</span><span class="o">.</span><span class="na">child</span><span class="o">,</span> <span class="n">target</span><span class="o">.</span><span class="na">pointerIdBits</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">58</span>                             <span class="n">handled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="lineno">59</span>                         <span class="o">}</span>
<span class="lineno">60</span>                         <span class="c1">// blahblah...</span>
<span class="lineno">61</span>     <span class="o">}</span>
<span class="lineno">62</span> <span class="o">}</span></code></pre></div>

<p>先看32行:</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * Returns true if a child view contains the specified point when transformed</span>
<span class="lineno"> 3</span> <span class="cm">     * into its coordinate space.</span>
<span class="lineno"> 4</span> <span class="cm">     * Child must not be null.</span>
<span class="lineno"> 5</span> <span class="cm">     * @hide</span>
<span class="lineno"> 6</span> <span class="cm">     */</span>
<span class="lineno"> 7</span>     <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isTransformedTouchPointInView</span><span class="o">(</span><span class="kt">float</span> <span class="n">x</span><span class="o">,</span> <span class="kt">float</span> <span class="n">y</span><span class="o">,</span> <span class="n">View</span> <span class="n">child</span><span class="o">,</span>
<span class="lineno"> 8</span>             <span class="n">PointF</span> <span class="n">outLocalPoint</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 9</span>         <span class="kd">final</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">point</span> <span class="o">=</span> <span class="n">getTempPoint</span><span class="o">();</span>
<span class="lineno">10</span>         <span class="n">point</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
<span class="lineno">11</span>         <span class="n">point</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
<span class="lineno">12</span>         <span class="n">transformPointToViewLocal</span><span class="o">(</span><span class="n">point</span><span class="o">,</span> <span class="n">child</span><span class="o">);</span>
<span class="lineno">13</span>         <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isInView</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">pointInView</span><span class="o">(</span><span class="n">point</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">point</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
<span class="lineno">14</span>         <span class="k">if</span> <span class="o">(</span><span class="n">isInView</span> <span class="o">&amp;&amp;</span> <span class="n">outLocalPoint</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">15</span>             <span class="n">outLocalPoint</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">point</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">point</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
<span class="lineno">16</span>         <span class="o">}</span>
<span class="lineno">17</span>         <span class="k">return</span> <span class="n">isInView</span><span class="o">;</span>
<span class="lineno">18</span>     <span class="o">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> 
<span class="lineno">21</span> 
<span class="lineno">22</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transformPointToViewLocal</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">point</span><span class="o">,</span> <span class="n">View</span> <span class="n">child</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">23</span>         <span class="n">point</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+=</span> <span class="n">mScrollX</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="na">mLeft</span><span class="o">;</span>
<span class="lineno">24</span>         <span class="n">point</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+=</span> <span class="n">mScrollY</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="na">mTop</span><span class="o">;</span>
<span class="lineno">25</span> 
<span class="lineno">26</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">child</span><span class="o">.</span><span class="na">hasIdentityMatrix</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">27</span>             <span class="n">child</span><span class="o">.</span><span class="na">getInverseMatrix</span><span class="o">().</span><span class="na">mapPoints</span><span class="o">(</span><span class="n">point</span><span class="o">);</span>
<span class="lineno">28</span>         <span class="o">}</span>
<span class="lineno">29</span>     <span class="o">}</span></code></pre></div>

<p>看到木有，point[0] = x + mScrollX - child.mLeft, 自己去画个图吧，这就是event在child里的坐标，不光跟child.mLeft有关，还跟parent的mScrollX有关<br />
还不信？在来看看dispatchTransformedTouchEvent(dispatchTouchEvent 56行)：</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * Transforms a motion event into the coordinate space of a particular child view,</span>
<span class="lineno"> 3</span> <span class="cm">     * filters out irrelevant pointer ids, and overrides its action if necessary.</span>
<span class="lineno"> 4</span> <span class="cm">     * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</span>
<span class="lineno"> 5</span> <span class="cm">     */</span>
<span class="lineno"> 6</span>     <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">dispatchTransformedTouchEvent</span><span class="o">(</span><span class="n">MotionEvent</span> <span class="n">event</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cancel</span><span class="o">,</span>
<span class="lineno"> 7</span>             <span class="n">View</span> <span class="n">child</span><span class="o">,</span> <span class="kt">int</span> <span class="n">desiredPointerIdBits</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">handled</span><span class="o">;</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>         <span class="c1">// Canceling motions is a special case.  We don&#39;t need to perform any transformations</span>
<span class="lineno">11</span>         <span class="c1">// or filtering.  The important part is the action, not the contents.</span>
<span class="lineno">12</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldAction</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
<span class="lineno">13</span>         <span class="k">if</span> <span class="o">(</span><span class="n">cancel</span> <span class="o">||</span> <span class="n">oldAction</span> <span class="o">==</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>             <span class="n">event</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">);</span>
<span class="lineno">15</span>             <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">16</span>                 <span class="n">handled</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">dispatchTouchEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
<span class="lineno">17</span>             <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">18</span>                 <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">dispatchTouchEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
<span class="lineno">19</span>             <span class="o">}</span>
<span class="lineno">20</span>             <span class="n">event</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="n">oldAction</span><span class="o">);</span>
<span class="lineno">21</span>             <span class="k">return</span> <span class="n">handled</span><span class="o">;</span>
<span class="lineno">22</span>         <span class="o">}</span>
<span class="lineno">23</span> 
<span class="lineno">24</span>         <span class="c1">// Calculate the number of pointers to deliver.</span>
<span class="lineno">25</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldPointerIdBits</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getPointerIdBits</span><span class="o">();</span>
<span class="lineno">26</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">newPointerIdBits</span> <span class="o">=</span> <span class="n">oldPointerIdBits</span> <span class="o">&amp;</span> <span class="n">desiredPointerIdBits</span><span class="o">;</span>
<span class="lineno">27</span> 
<span class="lineno">28</span>         <span class="c1">// If for some reason we ended up in an inconsistent state where it looks like we</span>
<span class="lineno">29</span>         <span class="c1">// might produce a motion event with no pointers in it, then drop the event.</span>
<span class="lineno">30</span>         <span class="k">if</span> <span class="o">(</span><span class="n">newPointerIdBits</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">31</span>             <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="lineno">32</span>         <span class="o">}</span>
<span class="lineno">33</span> 
<span class="lineno">34</span>         <span class="c1">// If the number of pointers is the same and we don&#39;t need to perform any fancy</span>
<span class="lineno">35</span>         <span class="c1">// irreversible transformations, then we can reuse the motion event for this</span>
<span class="lineno">36</span>         <span class="c1">// dispatch as long as we are careful to revert any changes we make.</span>
<span class="lineno">37</span>         <span class="c1">// Otherwise we need to make a copy.</span>
<span class="lineno">38</span>         <span class="kd">final</span> <span class="n">MotionEvent</span> <span class="n">transformedEvent</span><span class="o">;</span>
<span class="lineno">39</span>         <span class="k">if</span> <span class="o">(</span><span class="n">newPointerIdBits</span> <span class="o">==</span> <span class="n">oldPointerIdBits</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">40</span>             <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">child</span><span class="o">.</span><span class="na">hasIdentityMatrix</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">41</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">42</span>                     <span class="n">handled</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">dispatchTouchEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
<span class="lineno">43</span>                 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">44</span>                     <span class="kd">final</span> <span class="kt">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="n">mScrollX</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="na">mLeft</span><span class="o">;</span>
<span class="lineno">45</span>                     <span class="kd">final</span> <span class="kt">float</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="n">mScrollY</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="na">mTop</span><span class="o">;</span>
<span class="lineno">46</span>                     <span class="n">event</span><span class="o">.</span><span class="na">offsetLocation</span><span class="o">(</span><span class="n">offsetX</span><span class="o">,</span> <span class="n">offsetY</span><span class="o">);</span>
<span class="lineno">47</span> 
<span class="lineno">48</span>                     <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">dispatchTouchEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
<span class="lineno">49</span> 
<span class="lineno">50</span>                     <span class="n">event</span><span class="o">.</span><span class="na">offsetLocation</span><span class="o">(-</span><span class="n">offsetX</span><span class="o">,</span> <span class="o">-</span><span class="n">offsetY</span><span class="o">);</span>
<span class="lineno">51</span>                 <span class="o">}</span>
<span class="lineno">52</span>                 <span class="k">return</span> <span class="n">handled</span><span class="o">;</span>
<span class="lineno">53</span>             <span class="o">}</span>
<span class="lineno">54</span>             <span class="n">transformedEvent</span> <span class="o">=</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
<span class="lineno">55</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">56</span>             <span class="n">transformedEvent</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="n">newPointerIdBits</span><span class="o">);</span>
<span class="lineno">57</span>         <span class="o">}</span>
<span class="lineno">58</span> 
<span class="lineno">59</span>         <span class="c1">// Perform any necessary transformations and dispatch.</span>
<span class="lineno">60</span>         <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">61</span>             <span class="n">handled</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">dispatchTouchEvent</span><span class="o">(</span><span class="n">transformedEvent</span><span class="o">);</span>
<span class="lineno">62</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">63</span>             <span class="kd">final</span> <span class="kt">float</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="n">mScrollX</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="na">mLeft</span><span class="o">;</span>
<span class="lineno">64</span>             <span class="kd">final</span> <span class="kt">float</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="n">mScrollY</span> <span class="o">-</span> <span class="n">child</span><span class="o">.</span><span class="na">mTop</span><span class="o">;</span>
<span class="lineno">65</span>             <span class="n">transformedEvent</span><span class="o">.</span><span class="na">offsetLocation</span><span class="o">(</span><span class="n">offsetX</span><span class="o">,</span> <span class="n">offsetY</span><span class="o">);</span>
<span class="lineno">66</span>             <span class="k">if</span> <span class="o">(!</span> <span class="n">child</span><span class="o">.</span><span class="na">hasIdentityMatrix</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">67</span>                 <span class="n">transformedEvent</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">getInverseMatrix</span><span class="o">());</span>
<span class="lineno">68</span>             <span class="o">}</span>
<span class="lineno">69</span> 
<span class="lineno">70</span>             <span class="n">handled</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">dispatchTouchEvent</span><span class="o">(</span><span class="n">transformedEvent</span><span class="o">);</span>
<span class="lineno">71</span>         <span class="o">}</span>
<span class="lineno">72</span> 
<span class="lineno">73</span>         <span class="c1">// Done.</span>
<span class="lineno">74</span>         <span class="n">transformedEvent</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
<span class="lineno">75</span>         <span class="k">return</span> <span class="n">handled</span><span class="o">;</span>
<span class="lineno">76</span>     <span class="o">}</span>
<span class="lineno">77</span> 
<span class="lineno">78</span> 
<span class="lineno">79</span> 
<span class="lineno">80</span> 
<span class="lineno">81</span> 	<span class="cm">/**</span>
<span class="lineno">82</span> <span class="cm">     * Adjust this event&#39;s location.</span>
<span class="lineno">83</span> <span class="cm">     * @param deltaX Amount to add to the current X coordinate of the event.</span>
<span class="lineno">84</span> <span class="cm">     * @param deltaY Amount to add to the current Y coordinate of the event.</span>
<span class="lineno">85</span> <span class="cm">     */</span>
<span class="lineno">86</span>     <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">offsetLocation</span><span class="o">(</span><span class="kt">float</span> <span class="n">deltaX</span><span class="o">,</span> <span class="kt">float</span> <span class="n">deltaY</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">87</span>         <span class="k">if</span> <span class="o">(</span><span class="n">deltaX</span> <span class="o">!=</span> <span class="mf">0.0f</span> <span class="o">||</span> <span class="n">deltaY</span> <span class="o">!=</span> <span class="mf">0.0f</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">88</span>             <span class="n">nativeOffsetLocation</span><span class="o">(</span><span class="n">mNativePtr</span><span class="o">,</span> <span class="n">deltaX</span><span class="o">,</span> <span class="n">deltaY</span><span class="o">);</span>
<span class="lineno">89</span>         <span class="o">}</span>
<span class="lineno">90</span>     <span class="o">}</span></code></pre></div>

<p>看看46、65行吧， 我就不解释了</p>

<hr />
<p>getX又是什么鬼！</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * The visual x position of this view, in pixels. This is equivalent to the</span>
<span class="lineno"> 3</span> <span class="cm">     * {@link #setTranslationX(float) translationX} property plus the current</span>
<span class="lineno"> 4</span> <span class="cm">     * {@link #getLeft() left} property.</span>
<span class="lineno"> 5</span> <span class="cm">     *</span>
<span class="lineno"> 6</span> <span class="cm">     * @return The visual x position of this view, in pixels.</span>
<span class="lineno"> 7</span> <span class="cm">     */</span>
<span class="lineno"> 8</span>     <span class="nd">@ViewDebug.ExportedProperty</span><span class="o">(</span><span class="n">category</span> <span class="o">=</span> <span class="s">&quot;drawing&quot;</span><span class="o">)</span>
<span class="lineno"> 9</span>     <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getX</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">10</span>         <span class="k">return</span> <span class="n">mLeft</span> <span class="o">+</span> <span class="n">getTranslationX</span><span class="o">();</span>
<span class="lineno">11</span>     <span class="o">}</span></code></pre></div>

<p>这么看来， <font color="red">getX返回的是view的虚拟x坐标，所谓虚拟就是原本相对于parent的layout再加上translation的偏移</font></p>

<p>看来跟mScrollX没什么关系嘛， 那translationX到底是什么？</p>

<div class="highlight"><pre><code class="java"><span class="lineno"> 1</span> <span class="cm">/**</span>
<span class="lineno"> 2</span> <span class="cm">     * Sets the horizontal location of this view relative to its {@link #getLeft() left} position.</span>
<span class="lineno"> 3</span> <span class="cm">     * This effectively positions the object post-layout, in addition to wherever the object&#39;s</span>
<span class="lineno"> 4</span> <span class="cm">     * layout placed it.</span>
<span class="lineno"> 5</span> <span class="cm">     *</span>
<span class="lineno"> 6</span> <span class="cm">     * @param translationX The horizontal position of this view relative to its left position,</span>
<span class="lineno"> 7</span> <span class="cm">     * in pixels.</span>
<span class="lineno"> 8</span> <span class="cm">     *</span>
<span class="lineno"> 9</span> <span class="cm">     * @attr ref android.R.styleable#View_translationX</span>
<span class="lineno">10</span> <span class="cm">     */</span>
<span class="lineno">11</span>     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTranslationX</span><span class="o">(</span><span class="kt">float</span> <span class="n">translationX</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">12</span>         <span class="k">if</span> <span class="o">(</span><span class="n">translationX</span> <span class="o">!=</span> <span class="n">getTranslationX</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">13</span>             <span class="n">invalidateViewProperty</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="lineno">14</span>             <span class="n">mRenderNode</span><span class="o">.</span><span class="na">setTranslationX</span><span class="o">(</span><span class="n">translationX</span><span class="o">);</span>
<span class="lineno">15</span>             <span class="n">invalidateViewProperty</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>             <span class="n">invalidateParentIfNeededAndWasQuickRejected</span><span class="o">();</span>
<span class="lineno">18</span>             <span class="n">notifySubtreeAccessibilityStateChangedIfNeeded</span><span class="o">();</span>
<span class="lineno">19</span>         <span class="o">}</span>
<span class="lineno">20</span>     <span class="o">}</span>
<span class="lineno">21</span> 
<span class="lineno">22</span> 
<span class="lineno">23</span>     <span class="cm">/**</span>
<span class="lineno">24</span> <span class="cm">     * The horizontal location of this view relative to its {@link #getLeft() left} position.</span>
<span class="lineno">25</span> <span class="cm">     * This position is post-layout, in addition to wherever the object&#39;s</span>
<span class="lineno">26</span> <span class="cm">     * layout placed it.</span>
<span class="lineno">27</span> <span class="cm">     *</span>
<span class="lineno">28</span> <span class="cm">     * @return The horizontal position of this view relative to its left position, in pixels.</span>
<span class="lineno">29</span> <span class="cm">     */</span>
<span class="lineno">30</span>     <span class="nd">@ViewDebug.ExportedProperty</span><span class="o">(</span><span class="n">category</span> <span class="o">=</span> <span class="s">&quot;drawing&quot;</span><span class="o">)</span>
<span class="lineno">31</span>     <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getTranslationX</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">32</span>         <span class="k">return</span> <span class="n">mRenderNode</span><span class="o">.</span><span class="na">getTranslationX</span><span class="o">();</span>
<span class="lineno">33</span>     <span class="o">}</span></code></pre></div>

<p>讲道理， 看不清renderNode到底是什么东西， 有很多native的东西，貌似跟硬件有关？并且在draw方法里也看到了很多在drawingWithRenderNode条件下有一些不同的操作， 这里就留一个疑问吧</p>
<font color="red">大胆猜测, 是一套单独直接与底层接触的动画重绘机制，跟canvas没有太大的关系</font>

<h2 id="section"><em>总结</em></h2>
<p>getLeft() 就是你layout完跟parent之间的距离<br />
scroll 本质上是移动这个view的画布，同时里面的内容也会跟着移动<br />
getX() 原始在parent里的位置加上属性动画translation的偏移</p>

<p>RenderNode:</p>

<pre><code>A display list records a series of graphics related operations and can replay
them later. Display lists are usually built by recording operations on a
{@link DisplayListCanvas}. Replaying the operations from a display list avoids 
executing application code on every frame, and is thus much more efficient.
</code></pre>


  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">
	<div class="info">
      		<ul>
			<li>转载请注明出处<a class="this-link" href="http://moonfacex.github.io/moonface.github.io/android/2016/04/01/mLeft_mScrollX_translationX.html">http://moonfacex.github.io/moonface.github.io/android/2016/04/01/mLeft_mScrollX_translationX.html</a></li>
        		<li>如有疑问，可以微博私信我或者发邮件给我</li>
      		</ul>
    	</div>
    
    <div class="footer-col-1 column">
      <ul>
        <li>MoonfaceX</li>
        <li><a href="mailto:mr.moonfacex@gmail.com">mr.moonfacex@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/MoonfaceX/moonface.github.io">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
	  <a href="http://weibo.com/u/1005421853"
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">You'll never walk alone.</p>
    </div>

  </div>

</footer>


    </body>
</html>